define("MsPortalImpl/UI/Hubs/UI.FavoritesManagerDeferred",["require","exports","Fx/DependencyInjection","MsPortalImpl/Services/Services.AssetTypes","MsPortalImpl/Services/Services.BrowseCuration","MsPortalImpl/UI/Hubs/UI.BrowseManager","MsPortalImpl/UI/Hubs/UI.FavoritesManager","_oss/fuse","MsPortalImpl/Services/Services.Recents","FxHubs/ResourceManagement","MsPortalImpl/Resources/ImplScriptResources","Fx"],(function(e,s,t,i,o,a,r,n,l,c,d,h){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),s.FavoritesManagerDeferred=s.tokenFavoritesPerCategory=s.tokenFavorites=void 0;var u=MsPortalFx.Base,p=u.Constants.AssetNames,g=FxImpl.Assets,b=u.Diagnostics,v=MsPortalFx.tryImmediateResolve;b.createLog(e);const y=/\s+/g,m=MsPortalFx.find,f=MsPortalFx.stableSort,F={shouldSort:!0,includeScore:!0,includeMatches:!0,tokenize:!0,threshold:.3,location:0,distance:100,maxPatternLength:32,minMatchCharLength:2,keys:[{name:"label",weight:.9},{name:"keywords",weight:.3},{name:"resourceType",weight:.1}]},_=MsPortalFx.extend({matchAllTokens:!0},F);function M(e,s,t){return s===p.BrowseResourceGroupBlade&&(s=p.ResourceGroups),g.getAssetTypeOrResourceTypeIdByWindowId(e,s)+(t?"."+t.toLowerCase():"")}function C(e,s){const t=s.toLocaleLowerCase(),i=[],o=[];return e.forEach((e=>{e.item.assetType.compositeDisplayName.service.toLocaleLowerCase().startsWith(t)?i.push(e):o.push(e)})),i.concat(o)}function T(e,s,t,i){let o=new n(s,t?_:F).search(e);o=o.filter((e=>e.score<=F.threshold));const a=o.reduce(((e,s)=>(function(e){if(e.item.boost)if(e.item.boost>2&&(e.item.boost=2),e.item.boost<-2&&(e.item.boost=-2),e.item.boost>0)e.score=Math.pow(e.score,1+e.item.boost);else if(e.item.boost<0){const s=1+Math.abs(e.item.boost);e.score=Math.pow(e.score,1/s)}}(s),s.score<=F.threshold&&e.push(s),e)),[]);if(a.sort(((e,s)=>e.score-s.score)),i){const s=i.find((s=>s.toLocaleLowerCase()===e.toLocaleLowerCase()));if(null==s?void 0:s.length)return a}return C(a,e)}let w=class{constructor(e,s,t,a,n){this._assetTypeService=e,this._browseManager=s,this._favoritesManager=t,this._diContainer=a,this._recentsManager=n,this.categories=ko.observableArray(),this.categoriesLookup={},this.showCategories=ko.observable(!1),this.possibleFavorites=ko.observableArray(),this.possibleFavoritesLookup={},this._ltm=new FxImpl.TriggerableLifetimeManager,this._extensionToDefaultCategoryMap={},this._assetTypes=ko.observable(),this._categoriesInitialized=!1,this._categoriesWithSubCategoriesInitialized=!1,this._subCategoriesLocalizedNameMap={},this._recentsManager=this._diContainer.get(l.RecentServicesManager),this._assetTypes([]),v(this._assetTypeService.assetTypesComplete,(()=>{const e=this._browseManager.getFilteredAssetTypes()||[];e.length&&this._assetTypes(e)})),this.initializeCategories=(0,h.memoizePromise)((e=>{if(this._categoriesInitialized&&this._categoriesWithSubCategoriesInitialized){const s=e?this._categoriesWithSubCategories:this._categories;return Q(s)}{const s=this._curationPromise||(0,o.getBrowseCuration)(e),t=MsPortalFx.isFeatureEnabled("allserviceswithoverview")?(0,o.getAllServicesAdditionalData)():Promise.resolve(null);return e?this._categoriesWithSubCategoriesInitialized=!0:this._categoriesInitialized=!0,Q.all([s,t,this._assetTypeService.assetTypesComplete]).then((([s,t])=>{this._discoveryPolicy=s.discoveryPolicy||0,this._curationSearchKeywords=s.globalSearchKeywords;const o=(e,s)=>{const o=t&&t.categoriesDataMap[e],a={id:e,showLabel:ko.observable(!0),isFilteredOut:ko.observable(!1),isHidden:ko.pureComputed((()=>!a.possibleFavorites().some((e=>!e.isHidden())))),label:(0,i.provideCategoryName)(e),count:ko.observable(0),possibleFavorites:ko.observableArray(),sourceCategory:s,freeTrainings:o&&o.trainings,usefulLinks:o&&o.usefulLinks,seeAllTrainingsLink:o&&o.seeAllTrainingsLink};return a},a=s.categories||[],n=a.map((e=>o(e.id,e)));if(n&&n.length){const e=this._uncuratedCategory=o("uncurated");n.push(e)}this.categories(n),this.possibleFavorites().forEach((e=>{const s=r.getAssetTypeKind(e.assetType,e.kind),t=e.assetType,i=r.getAssetTypeDisplayText(t,s);e.label=i,e.labelId=i.replace(y,""),e.image=r.getAssetTypeIcon(t,s),e.keywords=(r.getAssetTypeKeywords(t,s)||"").split(","),e.isHidden(e.isHidden())}));const l={};return a.forEach((e=>{(e.discoveryExtensions||[]).forEach((s=>{l[s]=m(n,(s=>s.id===e.id))||this._uncuratedCategory}))})),this._extensionToDefaultCategoryMap=l,this._loadFlyoutMenu().then((s=>(e?this._categoriesWithSubCategories=s:this._categories=s,s)))}))}}))}updateForRecents(e,s){return this.initializeCategories(!!this._categoriesWithSubCategoriesInitialized||void 0).then((()=>this._recentsManager.getServices().then((t=>{const i=t&&t.length||0,o=e&&e.length;let a;if(s){if(e||(a=i>s?s:i),o>=s)return e.slice(0,s);a=s-o>=i?i:s-o}else a=i;if(0===a)return;const r=t.slice(0);r.sort(((e,s)=>s.timeStamp-e.timeStamp));const n=e&&e.slice(0)||[];for(let s=0;s<a;s++)if(!e||!MsPortalFx.find(e,(e=>r[s].assetId===e.id.toLowerCase()))){const e=this.possibleFavoritesLookup[r[s].assetId.toLowerCase()];e&&n.push({relevanceScore:ko.observable(1),id:e.id,image:e.image,isFavorite:e.isFavorite,label:e.label,labelId:e.labelId,keywords:e.keywords,matches:ko.observable(),uri:e.uri,opensExternal:e.opensExternal,isHidden:ko.observable(!1),isFilteredOut:ko.observable(!1),assetType:e.assetType})}return n}))))}_fuzzySearch(e,s,t,i){var o;let a=0;const r=[],n=e=>2===i&&!e.isPreview||1===i&&e.isPreview;if(e=null==e?void 0:e.trim()){let i=T(e,s,!1,t?this._curationSearchKeywords:void 0);if(e.split(" ").length>1){const a=T(e,s,!0,t?this._curationSearchKeywords:void 0);i.push(...a),i.sort(((e,s)=>e.score-s.score));const r=null===(o=this._curationSearchKeywords)||void 0===o?void 0:o.find((s=>s.toLocaleLowerCase()===e.toLocaleLowerCase()));(null==r?void 0:r.length)||(i=C(i,e)),i=MsPortalFx.unique(i,((e,s)=>MsPortalFx.areEqual(e.item.id,s.item.id)))}const l={};let c,h=1,u=0;i.forEach((e=>{if(!e.item.isHidden()){const s=[],t=[],i=e.matches;let o="",a="";i.forEach((e=>{var i;let a=0;const r=[],n=null===(i=e.value)||void 0===i?void 0:i.length;e.indices.forEach((s=>{r.push(e.value.slice(a,s[0])+"<b>"+e.value.slice(s[0],s[1]+1)+"</b>"),a=s[1]+1})),a<n&&r.push(e.value.slice(a,n+1));const l=r.join("");switch(e.key){case"label":o=l;break;case"keywords":s.push(l);break;case"resourceType":t.push(l)}}));const r=s.length&&`${d.Search.keywordSubNameFmt.format(s.join(","))}`,n=t.length&&`${d.Search.resourceTypeSubNameFmt.format(t.join(","))}`;a=r,a=n.length&&a.length?`${a}; ${n}`:a||n,l[e.item.id]={relevance:h++,matchData:{highLightedDisplayName:o,highLightedSecondaryName:a}},u++}})),s.forEach((e=>{const s=l[e.id],i=s&&s.relevance||0,o=s&&s.matchData,a=n(e);t?s&&(c={relevanceScore:ko.observable(i),id:e.id,image:e.image,isFavorite:e.isFavorite,label:e.label,labelId:e.labelId,keywords:e.keywords,matches:ko.observable(o),uri:e.uri,opensExternal:e.opensExternal,isHidden:e.isHidden,isFilteredOut:ko.observable(!s||a),assetType:e.assetType,isDisabled:e.isDisabled},r.push(c)):(e.relevanceScore(i),e.matches(o),e.isFilteredOut(!s||a))})),a=u}else s.forEach((e=>{e.isFilteredOut(n(e)),e.relevanceScore(0),e.matches({highLightedDisplayName:"",highLightedSecondaryName:""})})),a=s.length;return{filteredTypes:t?r:s,matchCount:a}}filterAllServices(e){var s;return(null===(s=e.possibleFavorites)||void 0===s?void 0:s.length)?Q(this._fuzzySearch(e.filter,e.possibleFavorites,e.dontApplyVisibility,e.releaseStatus)):this.initializeCategories().then((()=>Q(this._fuzzySearch(e.filter,this.possibleFavorites(),e.dontApplyVisibility,e.releaseStatus))))}dispose(){this._ltm.dispose()}_addBrowseMenuItem(e,s,t){const i=M(e.extension,e.assetTypeManifest.name,s),o=r.getFavoriteType({assetType:e,kind:s,diContainer:this._diContainer,assetTypeIdWithKind:i});if(!this.possibleFavoritesLookup[i.toLowerCase()]){this.possibleFavorites().push(o);const e=MsPortalFx.find(this._favoritesManager.favorites.value,(e=>e.id===o.id));e&&(o.isFavorite=e.isFavorite),this.possibleFavoritesLookup[o.id.toLowerCase()]=o}}_addBrowseMenuItemToCategory(e){const s=M(e.assetType.extension,e.assetType.assetTypeManifest.name,e.kind),t=r.getFavoriteType({assetType:e.assetType,kind:e.kind,diContainer:this._diContainer,assetTypeIdWithKind:s,boost:e.boost,subCategory:e.subCategory}),i=MsPortalFx.find(this._favoritesManager.favorites.value,(e=>e.id===t.id));if(i&&e.boost&&(i.boost=e.boost),!e.tempPossibleFavorites.some((e=>e.id===s))){const s=this.possibleFavoritesLookup[t.id.toLowerCase()];if(s){t.isFavorite=s.isFavorite,t.isFilteredOut=s.isFilteredOut,t.matches=s.matches,t.relevanceScore=s.relevanceScore;const i=t.isHidden=s.isHidden;i(i()||e.isHidden),e.boost&&(s.boost=e.boost)}e.tempPossibleFavorites.splice(e.index,0,t)}if(e.isHidden){const s=this.possibleFavorites().filter((e=>e.id===t.id))[0];s&&s.isHidden(e.isHidden)}}_loadFlyoutMenu(e){const s=this.possibleFavoritesLookup;this._assetTypes().forEach((s=>{this._addBrowseMenuItem(s,void 0,e)}));const t=this.categories();this.showCategories(!!t.length);const o=Object.keys(s).slice(0);t.forEach((e=>{const s=e.possibleFavorites;s();const t=e.sourceCategory,a=t&&t.items||[],r=[];a.length&&(a.forEach(((e,s)=>{let t,a,n=-1;if(this._assetTypes().some((i=>{if(function(e,s){return e.extensionName===s.extension&&e.assetType===s.assetTypeManifest.name}(e,i)){const o=(e.kind||"").toLowerCase();a=o&&i.kindMap&&i.kindMap[o]&&e.kind,n=s,t=i}return n>-1})),n>-1){a&&this._addBrowseMenuItem(t,a),MsPortalFx.remove(o,t.id.toLowerCase());const s=e.subCategoryId;let l=this._subCategoriesLocalizedNameMap[s];s&&!l&&(l=(0,i.provideSubCategoryName)(s),this._subCategoriesLocalizedNameMap[s]=l);const c={assetType:t,index:n,kind:a,isHidden:!!e.isHidden,tempPossibleFavorites:r,boost:e.boost,subCategory:l};this._addBrowseMenuItemToCategory(c)}})),s(r),e.count(r.filter((e=>!e.isHidden())).length))}));const r=this._uncuratedCategory,n=[];if(r){f(o.map((e=>s[e])),((e,s)=>(0,a.compareAssetTypeForSort)(e.label,s.label))).forEach((e=>{const s=e.assetType,t=this._extensionToDefaultCategoryMap[s.extension],i=t||r,o=!t&&1===this._discoveryPolicy||(0,c.supportsOption)(s.assetTypeManifest.options,1),a=this.possibleFavorites().filter((s=>s.id===e.id))[0];a&&a.isHidden(o);const l=i.possibleFavorites;let d=[];d=t?l():n;const h={assetType:s,index:d.length,kind:"",isHidden:o,tempPossibleFavorites:d};this._addBrowseMenuItemToCategory(h),l(d);const u=d.filter((e=>!e.isHidden())).length;i.count(u)}))}return this.possibleFavorites(f(this.possibleFavorites(),((e,s)=>(0,a.compareAssetTypeForSort)(e.label,s.label)))),Q(this.categories())}};w=__decorate([__metadata("fx:diagnostics",[e,"FavoritesManagerDeferred"]),t.Class(),__metadata("design:paramtypes",[i.AssetTypeService,a.BrowseManager,r.FavoritesManager,t.Container,l.RecentServicesManager])],w),s.FavoritesManagerDeferred=w}));