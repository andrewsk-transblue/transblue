define("FxInternal/ExtensionRuntime",["require","exports","Fx/DependencyInjection","FxInternal/Composition/ViewModelComposer","FxInternal/RpcEndPoints","FxHubs/ProvisioningRpc","FxInternal/Weave/SandboxRender","FxInternal/ResourceManagement/Permissions","FxInternal/Environment","FxInternal/Weave/Blade","FxInternal/RpcEndPointsCore","FxInternal/Composition/ViewModelAdapters","FxInternal/Composition/ViewModelComposer","FxInternal/Experimentation","FxInternal/Composition/ViewModelComposer"],(function(n,t,i,r,u,f,e,o,s,h,c,l,a,v,y){"use strict";function nt(n){var i=n.resourceName,t=n.logData,r=n.telemetryData;!ct||vt[i.toLowerCase()]||ft[i]||(ft[i]=!0,r?rt.trace({source:"ExtensionRuntime",action:r.action,data:r.data}):(t===null||t===void 0?void 0:t.message)&&g.warning(t===null||t===void 0?void 0:t.message))}function b(n,t){return MsPortalFx.pathJoin("/",n.extensionRoot,t)}function yt(n){return n.trustedLinkedDomains===undefined&&(n.trustedLinkedDomains=MsPortalFx.getEnvironmentValue("trustedLinkedDomains",null)),n}function et(n,t,i){return ut++,Q(MsPortalFx.require(MsPortalFx.ensureSuffix(n,"/")+i)).then((function(n){return yt(n[t])})).catch((function(n){if("data"in n){var r="Failed to retrieve the ".concat(t," definition for '").concat(i,"' from the server.\r\n"),u=n.data&&n.data.failedModules&&n.data.failedModules.length===1,f=u?n.data.failedModules[0].message:n.message,e="".concat(r).concat(f);throw FxImpl.createError(e,{innerErrors:n,data:n.data});}throw n;}))}function pt(n,t,i){var f=i&&MsPortalFx.isFeatureEnabled("bladeprefetch2")&&i.weaveBladesMap&&i.weaveBladesMap[t],r=f&&f.prewarmerDependencies,u=0;r&&MsPortalFx.tryImmediateResolve(MsPortalFx.require(b(i,"PrewarmerEntryPoint")),(function(t){for(var e,i=0,f=r;i<f.length;i++)e=f[i],n.get(t[e]);u=r.length}));u&&g.verbose("Successfully processed ".concat(u," prewarmer dependencies for '").concat(t,"'."))}function k(n,t){return __awaiter(this,void 0,void 0,(function(){var u,e,o,i,f,s;return __generator(this,(function(h){switch(h.label){case 0:return e=MsPortalFx.startTimer(),FxImpl.features.isNativePerf&&(u="ExtLoadBladeBundles: ".concat(r.getLocatorFriendlyName(t).toLowerCase()),performance.mark(u)),[4,et(n,"blade",t)];case 1:return o=h.sent(),i=MsPortalFx.clone(o,!0),[4,r.getViewModelClass(i.viewModelLocator)];case 2:return f=h.sent(),s=l.isWeaveEnabled(f),f&&f._fx&&f._fx.rebindable&&i.attributes&1&&(i.attributes&=-2),i.reflowReady=!0,s&&!i.isWeave&&(i.isWeave=!0,i.templateBlade.htmlTemplateInline=null,i.templateBlade.styleSheets=null),u&&performance.measure(u,u),i.viewModelBundleLoading||(i.viewModelBundleLoading={end:Date.now(),duration:e()}),[2,i]}}))}))}function ot(n){var t=n.resourceName,u=n.extensionName,i=n.authorization,f,r;if(t&&t.toLowerCase()!=="telemetrytoken"&&![w.Constants.Shell,"HubsExtension"].includes(u)){if(f=i?i.resourceAccess?"":"However, no 'resourceAccess' property was found in the extension-defined configuration":"However, this extension has not migrated to the extension-defined auth configuration",f&&nt({resourceName:t,logData:{message:"The extension '".concat(u,"' has requested a token for resource '").concat(t,"'. ").concat(f,". ").concat(at)}}),r=MsPortalFx.find(i===null||i===void 0?void 0:i.resourceAccess,(function(n){return n.name===t})),r)return nt({resourceName:t,telemetryData:{action:"getResourceAccessInfo",data:__assign({},r)}}),r;nt({resourceName:t,logData:{message:"The extension '".concat(u,"' has requested a token for resource '").concat(t,"'. However, extension-defined resource access configuration does not contain an entry for this resource. Please add the resource to the entension's configuration before making this request again.")}})}return null}function st(n){var t="Cannot find view model class for '".concat(n,"'. Maybe it is not correctly exported?");g.error(t);throw new MsPortalFx.Errors.CanceledError(t);}function wt(t){(FxImpl.isDevelopmentMode||MsPortalFx.isFeatureEnabled("internalonly"))&&Q.nextTick((function(){var f=["ai_session","ai_user","ARRAffinity","VstsSession"],e=["ai_authUser","mp_"],i=[],o=(document.cookie||"").split(";").map((function(n){return n.split("=")[0].trim()})),r,u;o.forEach((function(n){e.forEach((function(t){n.startsWith(t)&&(i.push(n),document.cookie="".concat(n,"=;expires=Thu, 01 Jan 1970 00:00:00 UTC"))}))}));i.length&&t.log("fx",{level:2,area:n.normalize("."),code:0,message:"Deleted cookie(s) for ".concat(MsPortalFx.getEnvironmentValue("extensionName"),": ").concat(i.join())});document.__lookupGetter__&&document.__lookupSetter__&&(r=document.__lookupGetter__("cookie"),u=document.__lookupSetter__("cookie"),r&&u&&(document.__defineGetter__("cookie",r.bind(document)),document.__defineSetter__("cookie",(function(i){var r=i.split("=")[0].trim();return f.includes(r)?u.call(document,i):(t.log("fx",{level:2,area:n.normalize("."),code:0,message:"Blocking cookie for ".concat(MsPortalFx.getEnvironmentValue("extensionName"),": ").concat(r)}),"")}))))}))}function bt(){var t=i.container,n=t.set(s.Environment,{extensionName:MsPortalFx.getEnvironmentValue("extensionName"),sdkEnv:MsPortalFx.getEnvironmentValue("sdkEnv"),shellTrustedLinkedDomains:FxImpl.internalEnv.shellTrustedLinkedDomains,trustedLinkedDomains:MsPortalFx.getEnvironmentValue("trustedLinkedDomains"),linkedDomainMap:FxImpl.internalEnv.linkedDomainMap}).get(FxImpl.Rpc.Client);n.start({instanceIndex:FxImpl.postBootEnv.instanceIndex,loadChannelFunction:undefined,originId:FxImpl.postBootEnv.extensionName,shellChannel:new FxImpl.Rpc.RpcChannel(FxImpl.localRpcPort),windowRedirectMap:FxImpl.postBootEnv.extensionRedirectMap});wt(n);t.set(v.ExperimentationManager,new v.ExperimentationManager(FxImpl.features,function(t){return void n.invokeRpc(FxImpl.Constants.RpcMethods.networkTelemetry,MsPortalFx.Base.Constants.Shell,t)},function(n){var t;return FxImpl.addQueryOverride((t={},t.experimentationflights=n.flights,t.experimentationvariables=n.variables,t.assignmentcontext=n.assignmentContext,t))})).get(tt);FxImpl.features.isNativePerf&&["PortalScripts","Oss","MsPortalFx"].forEach((function(n){performance.measure(MsPortalFx.getEnvironmentValue("extensionName")+": "+n,n+"Start",n+"End")}))}function kt(){return i.container.get(d)}var d,tt;Object.defineProperty(t,"__esModule",{value:!0});t.DEV=t.getInnerRuntime=t.ensureInitialized=t.Runtime=t.InnerRuntime=t.getExtensionDefinedResourceAccessInfo=t.loadBladeDefinition=void 0;var w=MsPortalFx.Base,it=w.Diagnostics,p=FxImpl.Extension,rt=it.Telemetry,ut=0,ht=MsPortalFx.Base.Diagnostics.Telemetry.Context.getBladeContext,g=w.Diagnostics.createLog(n),ct=MsPortalFx.isFeatureEnabled("logwarningsforunmigratedextensions"),lt=MsPortalFx.isFeatureEnabled("enableauthtelemetry"),at="Please follow the instructions here: https://github.com/Azure/portaldocs/blob/bb7a801c811884f3fe9ce4abe7afc8196c18004c/portal-sdk/generated/top-extensions-authentication-procedures.md#migrating-resource-access-configuration. For additional questions, please join our teams channel at http://aka.ms/portalfx/resourceaccessteams.",vt={noncaearm:!0},ft={};t.loadBladeDefinition=k;t.getExtensionDefinedResourceAccessInfo=ot;d=(function(){function t(n,t){var e=this,u,f,r;this._rpcClient=n;this._permissionChecker=t;this._ltm=new FxImpl.TriggerableLifetimeManager;it.ErrorReporter.initialize();this._extensionName=MsPortalFx.getEnvironmentValue("extensionName");u=this._authorization=MsPortalFx.getEnvironmentValue("authorization");u&&u.resourceAccess&&(this._authorization={resourceAccess:u.resourceAccess.map((function(n){return __assign(__assign({},n),{name:n.name.toLowerCase()})}))});this._tokenCache=w.Security.createAuthTokenCache((function(t){return p.getAuthorizationTokenEndPoint.invoke(n,"fx",t)}),FxImpl.postBootEnv.tokens);f=new Map;r=[];p.getReactModelEndPoint.register(n,"fx",(function(t){var s=n.detachPort("fx",t.portId),u=new FxImpl.TriggerableLifetimeManager,o;f.set(t.portId,u);o=t.modelName?Q(MsPortalFx.require(t.modelName)):Q(MsPortalFx.Models.React);Q.spread([o,MsPortalFx.require("@microsoft/azureportal-reactview/internal/FunctionProxy"),],(function(f,o){if(!u.isDisposed()){var c=function(){var t;return(t=FxImpl.NetDiagnostics.pendingAjaxCalls).concat.apply(t,n.getPendingInvokes())},l=function(n){return __awaiter(e,void 0,void 0,(function(){var i,t;return __generator(this,(function(u){switch(u.label){case 0:return i=c(),[4,n()];case 1:return u.sent(),t=c().filter((function(n){return!i.includes(n)&&!r.includes(n)})),t.forEach((function(n){Promise.race([Q.delay(6e4),n.promise.catch((function(){}))]).finally((function(){MsPortalFx.remove(r,n)}))})),r.push.apply(r,t),[2,Promise.all(t.map((function(n){var t=n.promise;return t.catch((function(){}))}))).then((function(){return{asyncOperations:t.map((function(n){return n.name}))}}))]}}))}))},h=new o.FunctionProxyImpl,a=new o.AsyncStoreImpl(h,l).initialized();new f({lifetime:u,asyncStore:a,functionProxy:h,getExperimentation:function(){return Promise.resolve(MsPortalFx.require("Fx/Experimentation").then((function(n){return i.container.getAsync(n.Experimentation).then((function(n){return n}))})))},viewParameters:t.parameters,diContainer:i.container});h.setPort(s)}}))}));p.disposeReactModelEndPoint.register(n,"fx",(function(n){var t=n.portId;f.get(t).dispose();n.unrequire&&FxImpl.unrequire(n.modelName)}));p.pingEndPoint.register(n,"fx",MsPortalFx.noop);p.getLocalGalleryPackagesEndpointDefinition.register(n,"fx",(function(){var n=MsPortalFx.getEnvironmentValue("localGalleryPackageEndpoint");return n&&FxImpl.ensureAbsoluteUri(n)}));MsPortalFx.Base.Net2.status.subscribe(this._ltm,(function(t){p.extensionStatusEndPoint.invoke(n,"fx",t)}));MsPortalFx.Base.Net2.initialize((function(n){return MsPortalFx.tryImmediateResolve(e.getAuthorizationToken(n),(function(n){return n&&n.header}))}))}return t.prototype.getAuthorizationToken=function(n){var t,u=MsPortalFx.getFeatureValue("authstamp");n=n||{};var f=(t=n.resourceName)===null||t===void 0?void 0:t.toLowerCase(),o=this._extensionName,e=n.audience||"",i=n.tenantId||"",r=ot({resourceName:f,extensionName:o,authorization:this._authorization});return r&&(e=r.resource,i=r.useInfrastructureTenant?FxImpl.internalEnv.fxAadInfrastructureTenantId:i,n=__assign(__assign({},n),{resourceName:f,audience:e,tenantId:i})),u&&(n=__assign(__assign({},n),{authConfigStamp:u})),lt&&rt.trace({source:"ExtensionRuntime",action:"getAuthorizationToken",data:{resourceName:n.resourceName,audience:n.audience||"___NOTFOUND___",tenantId:n.tenantId,authConfigStamp:n.authConfigStamp}}),Q(this._tokenCache.getToken(n))},t.prototype.getSharedSettings=function(){return this._settingsCache||(this._settingsCache=p.getSharedSettingsEndPoint.invoke(this._rpcClient,"fx",undefined))},t.prototype.getUserInfo=function(){return p.getUserInfoEndPoint.invoke(this._rpcClient,"fxw",undefined)},t.prototype.assetHasPermission=function(n,t){var i=this;return this.mapAssetIdToResourceId(n).then((function(n){return i._permissionChecker.hasPermission(n,t)}))},t.prototype.mapAssetIdToResourceId=function(n){return p.mapAssetIdToResourceIdEndPoint.invoke(this._rpcClient,"fx",n)},t.prototype.mapResourceIdToAssetId=function(n){return p.mapResourceIdToAssetIdEndPoint.invoke(this._rpcClient,"fx",n)},t.prototype.mapAssetIdToDynamicSelectionAndIcon=function(n,t){return p.mapAssetIdToDynamicSelectionAndIconEndPoint.invoke(this._rpcClient,"fx",{assetId:n,forceBladeSelection:t})},t.prototype.mapResourceIdToDynamicSelectionAndIcon=function(n,t){return p.mapResourceIdToDynamicSelectionAndIconEndPoint.invoke(this._rpcClient,"fx",{resourceId:n,forceBladeSelection:t})},t.prototype.getAssetTypeInformation=function(n,t){return p.getAssetTypeInformationEndPoint.invoke(this._rpcClient,"fx",{extensionName:n,assetType:t})},t.prototype.getResourceTypeAssetTypeInformation=function(n){return p.getResourceTypeAssetTypeInformationEndPoint.invoke(this._rpcClient,"fx",n)},t.prototype.getResourceAssetInformation=function(n){return p.getResourceAssetInformationEndPoint.invoke(this._rpcClient,"fx",n)},t.prototype.getResource=function(n,t,i){return p.getResourceEndPoint.invoke(this._rpcClient,"fx",{resourceId:n,skipCache:i,invoker:t})},t.prototype.dispose=function(){this._ltm.dispose()},__decorate([__metadata("fx:diagnostics",[n,"InnerRuntime"]),i.Class(),__metadata("design:paramtypes",[FxImpl.Rpc.Client,o.PermissionChecker])],t)})();t.InnerRuntime=d;tt=(function(){function t(n,t,i){var ft=this,s=i.sdkEnv,g=b(s,"_generated/Blades"),v,it,w,rt,d;f.register(n);p.postBootEndPoint.invoke(n,"fx",{requireConfig:MsPortalFx.getEnvironmentValue("requireConfig"),extensionEnvironment:FxImpl.postBootEnv.environment||fx.environment,features:FxImpl.features.value});var nt=new r.ViewModelProvider(s,{getPartViewModel:st,getViewModel:st},n,function(n,t){return rt(n,t)}),ot=n.pendingInvocationCount,ct=ko.observable(ot.totalCount);ot.subscribe(ct);var lt=FxImpl.NetDiagnostics.pendingCallCount,l=ko.pureComputed((function(){return lt()+ct()})),o,tt=function(n){if(n)return n!==(o===null||o===void 0?void 0:o.instanceId)&&(o={instanceId:n,interruptedParent:l()>0}),o.interruptedParent};p.getBladeDefinitionEndPoint.register(n,"fx",(function(n){return k(g,n).then((function(n){return __assign({},n)}))}));p.downloadBladeBundlesEndPoint.register(n,null,(function(n){k(g,n)}));p.getPartDefinitionEndPoint.register(n,"fx",(function(n){return et(b(s,"_generated/Parts"),"part",n)}));c.setExtensionFlightsEndPoint.register(n,"fxw",(function(n){return MsPortalFx.require("FxInternal/Experimentation").then((function(i){var r=t.get(i.ExperimentationManager);return r.setExtensionFlights(n)}))}));v=function(n){var t;if((t=it(n))!==null&&t!==void 0)return t.instanceId};it=function(n){var t;return FxImpl.TelemetryContext.usingState((function(){t=ht()}),n),t};r.getViewModelsDefinition.registerChannelFactory(n,(function(n,i){var r,f=n.type&64,e=f&&tt(v(n.telemetryContext)),o=((r=n===null||n===void 0?void 0:n.onInputsSetParameters)===null||r===void 0?void 0:r.inputs)||{},u=nt.getObservable(t.createChildContainer("viewModel").set(h.UntypedWeaveBladeParameters,o),i,n);return f&&(u=u.then((function(n){return n.internal.interruptedParent=e,n}))),u}));r.tryEarlyGetViewModelEndPoint.registerChannelFactory(n,(function(n,i){var o=ut,c=Date.now()-n.timestamp,r=n.bladeName,u=n.parameters||{},f=t.createChildContainer("viewModel").set(h.UntypedWeaveBladeParameters,u),l="Blade_".concat(MsPortalFx.sessionId,"_").concat(n.options.sequenceNumber,"_0"),a=tt(l);return e.isWeaveBladeEnabled&&pt(f,r,s),k(g,r).then((function(t){return nt.tryEarlyGetViewModel(f,r,u,n.options,t,i).then((function(n){return n&&(n.internal.interruptedParent=a),{definition:t,rpcDurationMs:c,viewModel:n,viewModelLoadIndex:o}}))}))}));p.getExtensionGalleryService.registerObjectFactory(n,{allowedOrigin:["fx","HubsExtension","Microsoft_Azure_Marketplace"],allowRemoteChanges:!0,handler:function(){return nt.getGalleryServiceViewModel(t.createChildContainer("viewModel"))}});u.registerRpcEndPoints(t);p.getCommandsDefinitionEndPoint.register(n,"fx",(function(){return MsPortalFx.require(b(s,"_generated/Commands"))}));w=Object.create(null);rt=function(n,t){return __awaiter(ft,void 0,void 0,(function(){var i=this;return __generator(this,(function(){return[2,w[t]||(w[t]=new Promise(function(r){var u,e,s="ExtBladeAjaxEnd: ".concat(t),f=function(n){n===void 0&&(n=!1);delete w[t];n?r(null):(u===null||u===void 0?void 0:u.dispose(),r({waitEnd:fx.getTimestamp(),interruptedByChild:t&&t!==(o===null||o===void 0?void 0:o.instanceId),lastAjaxCompleteTime:e,lastAjaxCompleteMark:s}))};l()===0?f():(u=n.createChildLifetime(),n.registerForDispose((function(){f(!0)})),l.subscribe(u,(function(n){return __awaiter(i,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return(n===0)?[4,Q.delay(0)]:[3,3];case 1:return t.sent(),[4,Q.delay(0)];case 2:t.sent();l()===0&&f();t.label=3;case 3:return[2]}}))}))})),lt.subscribe(u,(function(n){n===0&&(e=fx.getTimestamp(),FxImpl.features.isNativePerf&&performance.mark(s))})))}))]}))}))};p.waitForExtensionIdleEndPoint.register(n,null,(function(n,t,i){var r=n.bladeName,u=n.bladeInstanceId;return __awaiter(ft,void 0,void 0,(function(){var n,f,e,t,o,s;return __generator(this,(function(h){switch(h.label){case 0:return FxImpl.features.isNativePerf&&(n="ExtWaitForIdle: ".concat(a.getLocatorFriendlyName(r).toLowerCase()),performance.mark(n)),f=l(),e=fx.getTimestamp(),[4,rt(i,u)];case 1:return(t=h.sent(),!t)?[2,null]:(FxImpl.features.isNativePerf&&performance.measure(n,n),o=t.interruptedByChild,s=t.waitEnd,[2,{interruptedByChild:o,pendingOperationsCount:f,waitDuration:f===0?0:s-e}])}}))}))}));d=new Map;p.onNewReactViewEndPoint.register(n,"fx",(function(n){var r=n.viewName,u=n.sequenceNumber,t=y.getEarlyViewModelTelemetryContext(r,u),i=v(t),f=FxImpl.NetDiagnostics.listenForBlade(it(t));d.set(i,f);tt(i)}));p.onReactViewInteractiveEndPoint.register(n,null,(function(n){var i=n.bladeInstanceId,r=n.time,t=d.get(i);t===null||t===void 0?void 0:t.onInteractive(r)}));p.onReactViewDisposed.register(n,"fx",(function(n){var t=n.viewName,i=n.sequenceNumber,r=d.get(v(y.getEarlyViewModelTelemetryContext(t,i))).onDisposed;r()}));p.traceToExtensionEndPoint.register(n,"fx",(function(n){var t=n[0],i=n[1];FxImpl.TelemetryContext.usingState((function(){MsPortalFx.Base.Diagnostics.Telemetry.trace(t)}),i)}));p.endTraceToExtensionEndPoint.register(n,"fx",(function(n){var t=n[0],i=n[1],r=n[2],u=n[3],f=n[4];return FxImpl.TelemetryContext.usingState((function(){var n=MsPortalFx.Base.Diagnostics.Telemetry.startTrace(__assign(__assign({},t),{duration:i-t.timestamp}));return MsPortalFx.Base.Diagnostics.Telemetry.endTrace(n,r,u)}),f)}))}return __decorate([__metadata("fx:diagnostics",[n,"Runtime"]),i.Class(),__metadata("design:paramtypes",[FxImpl.Rpc.Client,i.Container,s.Environment,d])],t)})();t.Runtime=tt;t.ensureInitialized=bt;t.getInnerRuntime=kt}))