define("MsPortalImpl/Notifications/NotificationsAreaFunctions",["require","exports","MsPortalImpl/Services/Services.ArmEvents","MsPortalImpl/UI/Hubs/UI.NotificationManager","MsPortalImpl/Services/Services.AssetTypes"],(function(e,t,i,a,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setErrorLevel=t.showEventsNotifications=t.publishClientNotifications=t.handleServerEvents=t.handleRecommendationEvents=void 0;var o=MsPortalFx.Base,n=o.Diagnostics,s=o.Constants,l=MsPortalFx.Hubs.Notifications.ClientNotification,c=MsPortalFx.Hubs.Notifications.NotificationStatus;const u="recommendationExpirationDate",d="recommendation",p=(n.createLog(e),void 0),m={warning:0,error:1,critical:2},v=MsPortalFx.forEachKey,f={localizedValue:p,value:p};t.handleRecommendationEvents=function(e,t){if(t&&t.length){const i=[],o=[];t.forEach((t=>{const a=t.operationName,n=t.resourceUri,s=t.properties;if(a&&t.description&&s&&s[u]&&n){new Date(t.properties[u])>=new Date&&o.push(e.get(r.AssetTypeService).mapResourceIdToDynamicSelectionAndIcon(n,"Notifications.handleRecommendationEvents").then((e=>{const r=e.selection,o={};Object.keys(t.properties).filter((e=>e.startsWith(d))).forEach((e=>{o[e]=t.properties[e]})),r.detailBladeInputs=r.detailBladeInputs||{},MsPortalFx.extend(r.detailBladeInputs,{referrerInfo:o}),i.push({timestamp:new Date(t.eventTimestamp),status:c.Information,title:a.localizedValue||a.value,description:t.description,correlationIds:[t.correlationId],linkedBlade:r,isRecommendation:!0,additionalProperties:o,isServerEvent:!0,notificationId:l.generateClientNotificationId()})}),(e=>{})))}})),Q.allSettled(o).then((()=>{i&&i.length&&e.get(a.NotificationHandler).notificationsCallback({messageArg:i,diContainer:e,messageContext:{srcWindowId:s.Shell,callStack:null,destWindowId:s.Shell}})}))}};function g(e,t){let i=t.map((e=>{const t=e.properties;if(t){const i=function(e,t){if(!e)return null;let i=m[(e||"").toLowerCase()];i===p&&t&&"failed"===(t||"").toLowerCase()&&(i=1);if(!(1<=i))return null;return i?c.Error:c.Warning}(t.level,e.status);if(i){const a=t.description;if(a)return{timestamp:e.timestamp,status:i,title:e.operationName,description:a,correlationIds:[e.correlationId],isServerEvent:!0,additionalProperties:{subscriptionId:t.subscriptionId},caller:e.caller}}}}));i=i.filter(MsPortalFx.notNullOrUndefined),i.forEach((e=>{e.notificationId||(e.notificationId=l.generateClientNotificationId())})),i&&i.length&&e.get(a.NotificationHandler).notificationsCallback({messageArg:i,diContainer:e,messageContext:{srcWindowId:s.Shell,callStack:null,destWindowId:s.Shell}})}function h(e){const t=e.operationName||f,i=e.resourceProviderName||f;if(t.value&&i.value){const a=e.status||f,r=e.subStatus||f,o=e.eventName||f,n=e.eventSource||f,s={operationName:t.value,source:i.value,assetId:e.resourceUri,status:a.value,subStatus:r.value,correlationId:e.correlationId,timestamp:e.eventTimestamp&&new Date(e.eventTimestamp),caller:e.caller,properties:{correlationId:e.correlationId,description:e.description,eventChannels:e.eventChannels,eventDataId:e.eventDataId,eventName:o.value,eventNameLocalized:o.localizedValue||"",eventSource:n.value,eventSourceLocalized:n.localizedValue,eventTimestamp:e.eventTimestamp,level:e.level,operationId:e.operationId,operationName:t.value,operationNameLocalized:t.localizedValue,resourceGroupName:e.resourceGroupName,resourceProviderName:i.value||"",resourceProviderNameLocalized:i.localizedValue||"",resourceUri:e.resourceUri,status:a.value,statusLocalized:a.localizedValue,submissionTimestamp:e.submissionTimestamp,subscriptionId:e.subscriptionId,subStatus:r.value||"",subStatusLocalized:r.localizedValue||""}};return v(e.properties,((e,t,i)=>{i.hasOwnProperty(e)||(i[e]=t)}),s.properties),s}}t.handleServerEvents=function(e,t){t&&t.length&&(e.get(a.NotificationManager).addServerEvents(t.slice(0,100)),g(e,t),e.get(i.ArmEvents).matchEvents(t))},t.publishClientNotifications=g,t.showEventsNotifications=function(e,i){const a=[],r=[];i.forEach((e=>{((e&&e.eventSource||{}).value||"").toLowerCase()===d?a.push(e):r.push(e)}));const o=r.map(h).filter((e=>!!e));a.length&&(0,t.handleRecommendationEvents)(e,a),o.length&&(0,t.handleServerEvents)(e,ko.toJS(o))}})),
define("MsPortalImpl/Notifications/NotificationsFetchedFromClientHelper",["require","exports","FxHubs/ArmHelpers/ArmApisStartup","FxHubs/ArtHelpers/ArtApis","MsPortalImpl/Notifications/NotificationsAreaFunctions","MsPortalImpl/Services/Services.Settings","FxHubs/HubsSettingsSchema","MsPortalImpl/Services/Services.BrowserSettings"],(function(e,t,i,a,r,o,n,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DEV=t.writeLastFetchedRecommendationsTimesToUserSettings=t.setLastFetchedRecommendationsTime=t.startPollingForDigestEvents=t.getServiceHealthAlerts=t.getLastRecommendationsFetchTime=t.serviceHealthAlertsQuery=t.lastFetchTimes=t.defaultPollingInterval=void 0;var l=MsPortalFx.Base,c=l.Diagnostics.Telemetry;const u=l.Diagnostics.createLog(e),d=MsPortalFx.forEachKey;let p=MsPortalFx.isFeatureEnabled("argsubscriptions");const m=MsPortalFx.isFeatureEnabled("fasteventservice"),v=n.Keys.lastRecommendationsFetchTime,f=m?1e4:12e5;let g,h=0;function I(e,a){return e.map((e=>{const r=new Date;let o;if(a)o=S(e);else{const e=new Date;e.setMinutes(e.getMinutes()-t.defaultPollingInterval/6e4),o=e}const n=function(e,t,i){e=e<t?e:t;const a=new Date(t.getTime());return a.setDate(a.getDate()-i),e<a?a:e}(o,r,1),s=parseInt(MsPortalFx.getFeatureValue("eventsoverlapminutes"));s&&n.setMinutes(n.getMinutes()-(s>5?5:s));const l=(0,i.getDigestEventsApi)(e,n,r,a?"Category eq 'Recommendation'":undefined,50);return F(e,r),{uri:l,arrayResponse:!0,telemetry:"Notifications.load"}}))}function S(e){const i=t.lastFetchTimes||{};if(!i[e]){const t=new Date;t.setDate(t.getDate()-7),i[(e||"").toLowerCase()]=t}return t.lastFetchTimes=i,i[e]}function F(e,i){if(e){const a=t.lastFetchTimes||{};a[(e||"").toLowerCase()]=i,t.lastFetchTimes=a}}function T(e){g||(g=setTimeout((()=>{g=null;const i={},a=t.lastFetchTimes;a&&(i[v]=a);const r=e.get(o.SettingsManager);(0,o.writeUserSettings)(r,i,null)}),3e5))}t.defaultPollingInterval=m?5e3:6e4*(MsPortalFx.isFeatureEnabled("slowpollevents")?30:10),t.serviceHealthAlertsQuery='servicehealthresources\r\n| where type == "microsoft.resourcehealth/events"\r\n| project eventType = tostring(properties.EventType), status = properties.Status, description = properties.Title, trackingId = properties.TrackingId, summary = properties.Summary, priority = toint(properties.Priority), impactStartTime = properties.ImpactStartTime, impactMitigationTime = properties.ImpactMitigationTime, lastUpdateTime = properties.LastUpdateTime\r\n| where (eventType == "ServiceIssue" and status == "Active" and impactStartTime > ago(3d)) or (eventType == "SecurityAdvisory" and impactMitigationTime > now() and impactStartTime > ago(28d) and lastUpdateTime > ago(3d))\r\n| summarize arg_max(todatetime(lastUpdateTime), *) by eventType, priority\r\n| summarize arg_max(priority * -1, *) by eventType\r\n| project-away max_',t.getLastRecommendationsFetchTime=S,t.getServiceHealthAlerts=async function(e,i){const r=c.start({source:"NotificationsFetchedFromClientHelper",action:"getServiceHealthAlerts"});if(!(null==e?void 0:e.length)||!p)return c.completeTrace(r,{alertCount:0,subscriptionIdsCount:0,useArgToValidate:p}),[];try{const o={query:t.serviceHealthAlertsQuery,subscriptions:e,options:{$top:1e3,resultFormat:"objectArray"}},n=await Q(a.getDataFromArt(o,"NotificationsFetchedFromClientHelper.GetServiceHealthAlerts")).catch((async e=>{(null==e?void 0:e.httpStatusCode)>=500&&((await i.getAsync(s.ServiceDependencyState)).azureResourceGraphUnavailable(!0),u.error("ServiceErrorFromArg received from NotificationsFetchedFromClientHelper"))})),l=(null==n?void 0:n.data)||[];return c.completeTrace(r,{alertCount:l.length,resultCount:n.count}),l}catch(e){c.endTrace(r,"failure",{error:MsPortalFx.getLogFriendlyMessage(e)})}return[]},t.startPollingForDigestEvents=async function(e,a){if(h++,!a||!a.length)return;const n=a.slice(0,100).map((e=>e.subscriptionId));await async function(e,i){const a=e.get(o.SettingsManager),r=await(0,o.readUserSettings)(a,[v],null),n=MsPortalFx.convertArrayToMap(i,(e=>e.subscriptionId),MsPortalFx.identity),s=d(r,((e,t,i)=>{const a=Date.parse(t);!isNaN(a)&&n[e]&&(i[(e||"").toLowerCase()]=new Date(t))}),{});t.lastFetchTimes=s}(e,a);let s=!0;const l={pollingInterval:t.defaultPollingInterval},c=async a=>{if(a!==h)return;const o=[],d=I(n,s);s=!1;try{await(0,i.callBatchWithContinuation)(d,(e=>{o.push(...e),l.pollingInterval=t.defaultPollingInterval}),(e=>{!function(e,i,a){const r=e.reason||{},o=FxImpl.Azure.buildSimplifiedError(e.reason||e),n=r.httpStatusCode,s=((r.content||{}).error||{}).code||o.code||"",l=JSON.stringify(o);if(0===n)return u.verbose(l),void(a.pollingInterval=f);if(function(e,t){return!!~[401,403,404,410].indexOf(e)||400===e&&("disallowedprovider"===(t||"").toLowerCase()||"disallowedoperation"===(t||"").toLowerCase())}(n,s)){const r=e.api,o=/\/subscriptions\/(.*?)\/.*/i.exec(r);o&&MsPortalFx.remove(i,o[1]),a.pollingInterval=t.defaultPollingInterval}u.warning(l)}(e,n,l)}),!0)}catch(e){}if(a===h){o.length&&s&&T(e);try{o.length&&r.showEventsNotifications(e,o),await Q.delay(l.pollingInterval),c(a)}catch(e){}}};c(h)},t.setLastFetchedRecommendationsTime=F,t.writeLastFetchedRecommendationsTimesToUserSettings=T}));