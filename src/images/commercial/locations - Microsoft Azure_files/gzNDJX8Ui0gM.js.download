define("MsPortalImpl/UI/Commands/UI.CommandBarManager",["require","exports","FxInternal/Composition/ViewModel","MsPortalImpl/Base/Base.ImplUtils","MsPortalImpl/Extension/DefinitionCache","MsPortalImpl/UI/Commands/UI.Commands","MsPortalImpl/UI/Compositions/UI.Composition.PropertyBinding","MsPortalImpl/Widgets/Widgets.CommandBar","MsPortalImpl/UI/Compositions/UI.Composition.Selectable2Registrar","MsPortalImpl/Base/Base.Selectable2"],(function(e,t,i,n,s,o,a,r,l,d){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.create=void 0;MsPortalFx.Base.Diagnostics;const c=MsPortalFx.disposeDisposable;t.create=function(t,h,p,m){const u=ko.observable([]),f=ko.observable([]);return t.registerForDispose((()=>{u().forEach(c),f().forEach(c)})),o.getCommandGroupForDefinitionItem(p.get(s.DefinitionCache),h.extension.name,h.bladeDefinition).then((s=>{s?function(e,t,i,n,s,a){const l=t.widget,d=[],c=n.commands.map((n=>{const a=new o.ExtensionCommandMenuItemImpl(e,t.extension,t,n,t.bladeDefinition,i,s);return a.activate(),d.push(a),new r.PdlCommandButton(e,a)})),h=l.options.contextMenu.menuItems;h.push.apply(h,d),l.options.commandBar.menuItems(d),a(c)}(t,h,p,s,m,u):function(t,s,o,r){const c=s.bladeDefinition.toolbar,h=c?c.source.valuesFrom[0]:null;if(h){const o=MsPortalFx.find(MsPortalFx.mapMany(s.children,(e=>e.children)),(e=>e.locator.name===h.part));let c;const p=ko.observable(!0);s.uiBlockers.push(p),o.await(6).then((()=>{const p=o.getViewModel(0),m=a.getModelValue(p,h.property);if(m.exists){d.setSelectableContext(t.createChildLifetime(),p,s.widget.element),s.widget.options.renderCmdBarWhenNoCmd(!0);const e=m.value.items;MsPortalFx.isObservableArray(e)?e.subscribeAndRun(t,(e=>{(0,l.registerOpenBladeCommands)(e,p,o,"commandBar2Selectables",void 0)?r(e):r([])})):c="Invalid view model for the toolbar at '{0}' in part '{1}'. It is missing the items property"}else i.isV2(p.content())||(c="Unable to find the view model for the toolbar at '{0}' in part '{1}'.");if(c){c=c.format(h.property,o.locator.toFriendlyString());const t=FxImpl.createError(c);(0,n.logToExtension)(e,o.extension.name,2,t)}})).finally((()=>p(!1)))}}(t,h,0,f),ko.reactor(t,(()=>{const e=s?u():f();h.widget.options.commandBar.items(e.slice())}))}))}})),
define("MsPortalImpl/UI/Commands/UI.Commands.Blade",["require","exports","FxInternal/AsyncLoader","MsPortalImpl/Resources/ImplScriptResources","MsPortalImpl/UI/Commands/UI.Commands","MsPortalImpl/UI/Commands/UI.ShellCommands"],(function(e,t,i,n,s,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ResetLayout=t.setDisplayStateCommands=t.getDisplayStateCommand=t.BladeDisplayStateCommand=t.Edit=t.Pin=void 0;var a=MsPortalFx.Base.Images,r=MsPortalFx.Blades.Internal.DisplayState;const l=n.ShellCommands;class d extends o.ShellCommand{constructor(e,t){super(e,t,o.CommandNames.PinBlade,{text:l.pinToStartboard,icon:a.Pin()})}execute(e){return this._getComposition().getPinOptions().then((e=>i.get("MsPortalImpl/UI/Dashboard/Common/DashboardPinHelper","pinTilesWithDashboardSelection").then((t=>t(this._diContainer,"Blade",e))))).finally((()=>{super.execute(e)}))}}t.Pin=d;class c extends o.ShellCommand{constructor(e,t,i){super(e,t,o.CommandNames.EditBlade,{text:l.editBlade,icon:a.Edit()}),this._lifetimeManager=e,this._onModeChanged=i}async execute(e){if(!this._editor){const e=await MsPortalFx.require("MsPortalImpl/UI/Dx/UI.Editor");this._editor=new e.Editor(this._diContainer),this._lifetimeManager.registerForDispose(this._editor)}if(this._editing)this._editor.save();else{const e=this._getComposition();this._editor.injectIntoBlade(e)}this._changeMode(!this._editing),super.execute(e)}reset(){this._editor&&(this._changeMode(!1),this._editor.disableRegions())}_changeMode(e){this._editing=e,this._onModeChanged(e)}}t.Edit=c;class h extends o.ShellCommand{constructor(e,t,i,n){super(e,t,o.CommandNames.BladeDisplayState+r[n],{text:i}),this.targetState=n}execute(e){const t=(0,s.getBladeContainerWidget)($(this._currentContext.target));t&&t.options.displayState(this.targetState),super.execute(e)}bind(e){const t=(0,s.getBladeContainerWidget)($(e.target));super.bind(e),this.enabled(t&&this.targetState===t.options.displayState())}}let p;t.BladeDisplayStateCommand=h;let m;t.getDisplayStateCommand=function(e,t){return m||(p=p||new FxImpl.TriggerableLifetimeManager,m=[],m[1]=new h(p,e,l.bladeRestore,1),m[2]=new h(p,e,l.bladeMaximize,2)),m[t]},t.setDisplayStateCommands=function(e){m&&(p&&p.dispose(),m=null),m=e};class u extends o.ShellCommand{constructor(e,t,i,n){super(e,t,o.CommandNames.ResetLayout,{text:l.resetLayout,icon:a.Refresh(),enabled:!0!==i}),this.bind=e=>{super.bind(e),this.enabled(!0!==i&&0!==n())}}execute(e){this._getComposition().resetLayout(),super.execute(e)}bind(e){}}t.ResetLayout=u})),
define("MsPortalImpl/UI/Compositions/UI.Composition.BladeHistory",["require","exports","Fx/DependencyInjection"],(function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BladeHistory=void 0;let n=class{constructor(){this._history=[],this._openBlades=new Map}getEntries(){return this._history.slice()}recordBladeOpened(e){if(e.locator){const t={bladeReference:{bladeName:e.locator.name,extensionName:e.locator.getExtensionLocator().name},timestamp:Date.now()};this._history.unshift(t),this._openBlades.set(e.id,t),this._history.length>30&&this._history.pop(),e.registerForDispose((()=>this._recordBladeClosed(e)))}}_recordBladeClosed(e){const t=this._openBlades.get(e.id);t&&(t.duration=Date.now()-t.timestamp),this._openBlades.delete(e.id)}};n=__decorate([__metadata("fx:diagnostics",[e,"BladeHistory"]),i.Class()],n),t.BladeHistory=n})),
define("MsPortalImpl/UI/Compositions/UI.Composition.BladeTelemetry",["require","exports","Fx/DependencyInjection","Fx","MsPortalImpl/Extension/Extension.Manifest","MsPortalImpl/Widgets/Widgets.Common","MsPortalImpl/Services/Services.BrowserSettings","MsPortalImpl/UI/Compositions/UI.Composition","FxInternal/AsyncLoader"],(function(e,t,i,n,s,o,a,r,l){"use strict";var d;Object.defineProperty(t,"__esModule",{value:!0}),t.BladeTelemetry=t.bladeFullReadyTimeout=void 0;var c=MsPortalFx.Base.Diagnostics.Telemetry,h=c.ActionModifier,p=FxImpl.TelemetryContext;t.bladeFullReadyTimeout=6e4;const m=window,u=m.fx.getTimestamp,{cancelOnDispose:f}=MsPortalFx.Base.Promises,g=[void 0,"StartboardPart","SideBar","DeepLink","Desktop","Home","GlobalSearch","AllServices","Notification","AvatarMenu","KeyBoardShortcut","FeedbackPane","TopBar","DebugPane"],b={0:"Small",1:"Medium",2:"Large",3:"XLarge",51:"Menu"},y={0:"Default",1:"TemplateBlade",2:"FrameBlade",3:"MenuBlade",4:"AppBlade",5:"AzBlade",6:"ReactView"};let I=d=class{constructor(e){this._diContainer=e,this._markers={},this._perfData={},this._additional={}}initializeBladeTelemetry(e,t,i){const n=this._perfData={includesExtensionLoadTime:!t.bladeDefinition},o=t.masterContainer,a=o&&o.locator,l=a&&a.toFriendlyString(),c=o&&o.instanceId,h=l,p=t.openedByInfo,m=p.openedByContext;if(this._blade=t,o&&o.getCompositionType()===r.CompositionType.Blade){const e=o;e.bladeDefinition&&e.bladeDefinition.menuBlade&&(this._menuBlade=e,this._menuBladeTelemetry=e.diContainer.get(d))}p.openedBy&&(n.openedBy=g[p.openedBy],n.isFavorite=2===p.openedBy&&m.openedBy&&1===m.openedBy,n.openedByPartName=p.openedByPartName),c&&(n.openedByBlade=c),h&&(n.openedByBladeName=h),i&&(n.preloadPartSettings=!0);const f=t.extension,b=t.locator,y=this._additional={extension:f&&f.name||b&&b.getExtensionName(),locator:b&&b.toFriendlyString(),assetType:e};y.extension&&(n.extVersion=this._diContainer.get(s.ManifestCache).getVersion(y.extension));const I=e=>{this._markers[e]=u(),this._markers["Menu"+e]=null},_=t.widget,C=_&&_.timer;return C&&(n.delayTime=C()),performance.mark("BladeFullReady: "+y.locator.toLowerCase()),I("BladeFullReady"),I("BladeSettled"),this.readyStartTime=u(),this.readyStartTimeCommon=Date.now(),this._perfData}traceBladeComplete(e,i,n){const o=this._blade;this._initializeTelemetryDetails(o,e);const r=o.extension;this._perfData.extVersion=r&&this._diContainer.get(s.ManifestCache).getVersion(r.name);const l=this._perfData;l.clickToFullReadyTime=Date.now()-o.openInitiatedTimestamp,!l.rejectedPromises&&i<t.bladeFullReadyTimeout&&(clearTimeout(i),MsPortalFx.isFeatureEnabled("showhatsmodal")&&a.temporaryExtensionCount.incrementCount(o.extension.name),n&&(this._perfData.deepLinkContext=o.masterContainer.getDeepLinkContext()),this._bladeFullReadyTelemetry(h.Complete,o,l)),this._refreshTelemetryInsightsOverlay(o)}traceBladeLoadErrored(e,t){const i=!this._markers.BladeFullReady,n=i?"BladeErrored":"BladeLoadErrored";this._markers[n]=this._markers.BladeFullReady||u(),i||this._traceWithState("BladeFullReady",h.Cancel,this._blade)(),t=Object.assign(Object.assign({},this._perfData),t),this._traceWithState(n,e,this._blade,t)()}beginTraceBladeDisposed(){this._blade&&(MsPortalFx.forEachKey(this._markers,((e,t)=>{t&&this._traceWithState(e,h.Cancel,this._blade)()})),this._closedTime=this._markers.BladeClosed=u())}endTraceBladeDisposed(){this._blade&&this._traceWithState("BladeClosed",h.Complete,this._blade,{TotalTimeBladeOpen:this._closedTime-this.readyStartTime})()}_initializeTelemetryDetails(e,t){const i=t.filter((e=>"rejected"===e.state)),n=this._perfData,s=e.bladeDefinition;n.lockedBlade=!!s.locked,n.useDetailContent=e.useDetailContent,n.bladeType=y[(0,r.getBladeType)(s)],n.bladeWidth=2===n.initialDisplayState?"Fullscreen":b[s.width]||"Fullscreen",n.reflowReady=!!s.reflowReady,n.inContextPane=!!(1&e.flags),n.isWeave=!!s.isWeave,n.resource=e.openedByInfo.openedByContext&&e.openedByInfo.openedByContext.deepLink,0===i.length?n.earlyOnInputsSetBlade=e.earlyOnInputsSet:n.rejectedPromises=i.length,n.telemetryName=e.telemetryName||""}_refreshTelemetryInsightsOverlay(e){!n.isFeatureEnabled("telemetryinsights")||1&e.flags||this._diContainer.getAsync(l.get("MsPortalImpl/Services/Services.TelemetryInsights","TelemetryInsights")).then((e=>{e.overlayVisible&&(e.clear(),e.toggleOverlay(this._blade,!1,this._blade.containerWidget.element)),e.forceInitialLoad&&e.toggleOverlay(this._blade,!0,this._blade.containerWidget.element)}))}_traceTelemetry(e,t,i,n,s,o){const a=this._additional;p.usingState((()=>{c.trace({extension:a.extension,source:"Shell",action:e,actionModifier:t,context:o,data:n,name:s.locator&&s.locator.toFriendlyString(),assetType:a.assetType,journeyId:s.journeyId,serviceTreeId:s.extension&&s.extension.serviceTreeId,duration:i})}),o)}_traceWithState(e,t,i,n){const s=this._markers;if(!s[e])return MsPortalFx.noop;delete s[e];const o="BladeFullReady"===e&&(null==n?void 0:n.reactViewInitializeEnd)?Math.max(n.reactViewInitializeEnd-this.readyStartTimeCommon,0):u()-this.readyStartTime;let a;if(this._menuBlade&&i.useDetailContent){const s="Menu"+e,r=this._menuBladeTelemetry,l=r._markers||{};if(s in l){delete l[s];const e=u()-r.readyStartTime,d=this._menuBlade.getCreationState();a=a=>{this._menuBlade.await(4).finally((()=>{p.usingState((()=>{const r=this._menuBlade.locator,l=i.locator,d=this._menuBlade.menu,h=d&&d.getResourceType()||this._menuBlade.assetType,p=d&&d.getTelemetryInfo()||{};c.trace({name:r.toFriendlyString(),extension:r.getExtensionName(),source:"Shell",action:s,actionModifier:t,data:$.extend({detailName:l.toFriendlyString(),detailExtension:i.extension&&i.extension.name,detailDuration:o,type:h,resourceId:i.assetId()||i.parent&&i.parent.getCurrentResourceId()},n||{},a&&a(this._menuBlade)||{},p),duration:e,journeyId:i.journeyId})}),d)}))}}}const r=i.getCreationState();return(s,l,d)=>(this._traceTelemetry(e,t,d||o,MsPortalFx.extend2(n,s),i,r),a&&a(l),d||o)}_bladeFullReadyTelemetry(e,t,i){const n=e=>e.locator.toFriendlyString().toLowerCase(),s=e=>"BladeFullReady: "+e,a=this._traceWithState("BladeFullReady",e,t,i),l=n(t),d=s(l),c=d+"-end";performance.mark(c),performance.measure(d,d,c);const p=function(e){return(0,r.bladeImplementedWithVirtualPart)(e.bladeDefinition)&&MsPortalFx.find(MsPortalFx.mapMany(e.children,(e=>e.children)))}(t);p&&p.onBladeFullReady(d,c,(0,r.getBladeType)(t.bladeDefinition));const g=t.widget.element[0];f(t,Q((0,o.waitForBindings)(g)).timeout(1e4).then(MsPortalFx.noop,MsPortalFx.noop)).finally((()=>{var e;const i=u(),o=d+"-render",r=e=>{const t=e?n(e):l;performance.measure(`${e?"Menu":""}BladeFullRender: ${t}`,e?s(t):d,o)};performance.mark(o),r();const c=i-this.readyStartTime;t.fullReadyTime(a({bladeRenderTime:c},(e=>(r(e),{menuBladeRenderTime:i-this._menuBladeTelemetry.readyStartTime})))),m.requestAnimationFrame((()=>{const e=document.createEvent("Event");e.initEvent("fxbladefullrender",!0,!0),g&&g.dispatchEvent(e)}));const p=async e=>{await Q.delay(0),this._traceWithState("BladeSettled",h.Complete,this._blade,this._perfData)(Object.assign({bladeRenderTime:c,bladeReadyTime:t.fullReadyTime()},e&&Object.assign({pendingExtensionOperationsCount:e.pendingOperationsCount,extensionWaitForSettledTime:e.waitDuration},e.interruptedByChild&&{interruptedByChild:!0}))),performance.measure(`BladeSettled: ${l}`,d)},b=(null===(e=t.extension)||void 0===e?void 0:e.waitForIdle)&&f(t,t.extension.waitForIdle(t.locator.name,t.instanceId));b?b.then(p):p()}))}};I=d=__decorate([__metadata("fx:diagnostics",[e,"1"]),i.Value("composition"),__metadata("design:paramtypes",[i.Container])],I),t.BladeTelemetry=I})),
define("MsPortalImpl/UI/Compositions/UI.Composition.Lens",["require","exports","MsPortalImpl/Extension/Extension.Definition.Locator","MsPortalImpl/UI/Compositions/UI.Composition","MsPortalImpl/UI/Compositions/UI.Composition.Base","MsPortalImpl/UI/Compositions/UI.Composition.Part","MsPortalImpl/Widgets/Widgets.Lens"],(function(e,t,i,n,s,o,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.create=t.Instance=void 0;var r=MsPortalFx.Base.Diagnostics,l=n.CompositionType;const d=r.createLog(e);class c extends s.Instance{constructor(e,t,n,s,o,a){super("Lens",e,t,n,s,o,a),this._childOnInputsSetsResolved=Q.defer(),this._finder=e.get(i.DefinitionFinder)}awaitChildrenOnInputsSetsResolved(){return this._childOnInputsSetsResolved.promise}getCompositionType(){return l.Lens}_compose(e,t){const i=Q({}),n=function(e,t){const i=t.locate(e.locator);return i&&i.isSummary}(this,this._finder),s=new a.ViewModel(this.id,this.diContainer);ko.computed(this,(function(){s.locked(e.options.locked())}));const o=$(FxImpl.createElement("div",{class:n?"fxs-portal-border":""}));if(this.widget=new a.Widget(o,s),n?(s.locked(!0),e.setSummary(o)):e.addChild(this.widget),this._finder.locateAsync(this.locator.getExtensionLocator()).then((e=>{const t=this._finder.locate(this.locator);if(t&&t.title){const i=t.title;i?s.title(i):d.error("Lens {0} in extension {1} is missing title.".format(this.locator.toString(),e.name))}})),this.children){const e=this.children.slice();Q.allSettled(e.map((e=>{const t=e.await(3);return e.compose(this.widget),t}))).finally((()=>{this._childOnInputsSetsResolved.resolve()})),this.save(),i.then((()=>{t.resolve()}))}}}t.Instance=c,t.create=function(e,t,n){const s=e.get(i.DefinitionFinder).locate(t),a=new c(e,t,null,null,null,n);if(s&&s.partInstances){const i=[];s.partInstances.forEach((s=>{const a=o.create(e,t.withPartInstance(s.name),null,null,null,n);i.push(a)})),a.addChildren(i)}return a}})),
define("MsPortalImpl/UI/Compositions/UI.Composition.Blade",["require","exports","Fx","MsPortalImpl/Resources/ImplScriptResources","MsPortalImpl/Base/Base.ImplUtils","MsPortalImpl/Base/Telemetry","MsPortalImpl/Base/Base.DeepLink","MsPortalImpl/Base/Base.HistoryManager","FxInternal/Controls/Notice","MsPortalImpl/Extension/Extension.Definition.Locator","MsPortalImpl/Extension/Extension.Manifest","MsPortalImpl/Extension/ViewModelManager","MsPortalImpl/Interactions/Interactions.FocusHandler","MsPortalImpl/Interactions/Interactions.PortalReader","MsPortalImpl/Services/Services.AssetTypes","MsPortalImpl/Services/Services.EditScopeManagement","MsPortalImpl/UI/UI.DeepLink","MsPortalImpl/UI/UI.DialogManager","MsPortalImpl/Widgets/Widgets.Blade","MsPortalImpl/Widgets/Widgets.BladeContent","MsPortalImpl/Widgets/Widgets.PartError","MsPortalImpl/Widgets/Widgets.UIElementBase","MsPortalImpl/UI/Commands/UI.CommandBarManager","MsPortalImpl/UI/Commands/UI.Commands","MsPortalImpl/UI/Commands/UI.Commands.Blade","MsPortalImpl/UI/Commands/UI.ShellCommands","MsPortalImpl/UI/UI.JourneyManager","MsPortalImpl/UI/Compositions/UI.Composition","MsPortalImpl/UI/Compositions/UI.Composition.Base","MsPortalImpl/UI/Compositions/UI.Composition.BladeHistory","MsPortalImpl/UI/Compositions/UI.Composition.BladeOpener.Helpers","MsPortalImpl/UI/Compositions/UI.Composition.BladeTelemetry","MsPortalImpl/UI/Compositions/UI.Composition.CompositionAwaiter","MsPortalImpl/UI/Compositions/UI.Composition.CompositionBinder","MsPortalImpl/UI/Compositions/UI.Composition.Finder","MsPortalImpl/UI/Compositions/UI.Composition.Lens","MsPortalImpl/UI/Compositions/UI.Composition.Part","MsPortalImpl/UI/Compositions/UI.Composition.PropertyBinding","MsPortalImpl/UI/Compositions/UI.Composition.Security","MsPortalImpl/Widgets/Widgets.Portal.init"],(function(e,t,i,n,s,o,a,r,l,d,c,h,p,m,u,f,g,b,y,I,_,C,M,P,B,w,D,x,S,v,T,E,F,k,R,V,U,A,L,W){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Instance=t.create=void 0;var O=FxImpl.TelemetryContext,N=O.ContextType,j=MsPortalFx.Base,H=MsPortalFx.Errors,z=j.Constants.BladeParameterNames,q=j.Diagnostics,K=q.Telemetry,J=j.Images,G=MsPortalFx.Extension.SetRequirement,X=K.ActionModifier,Y=MsPortalFx.tryImmediateResolve;const Z=window.fx.getTimestamp,ee=q.createLog(e),te=n.Asset,ie=n.Blade,ne=n.Shell.Reader,se="__{0}_StatusBarCommandDefinitionName__",oe=!!MsPortalFx.trace.bladerebind,ae=Math.random()<.5,re=MsPortalFx.isNullOrUndefined,le="fxs-menublade",de="fxs-blade-shows-pending",ce=Array.isArray,he=1e3,pe=ko.toJSON,me=ko.utils,ue=me.peekObservable,fe=MsPortalFx.disposeDisposable,ge=JSON.stringify,{cancelOnDispose:be}=MsPortalFx.Base.Promises;function ye(e){return e.getExtensionLocator()}function Ie(e){const t=e&&ye(e);return t&&t.name}function _e(e){return e&&e.toFriendlyString()}function Ce(e){const t=e.openedByInfo,i=t&&t.openedByContext;return i&&i.openedAsHome}function Me(e){const t=e.masterContainer,i=t&&t.bladeDefinition;return!(!i||!i.menuBlade)}function Pe(e){const t=e.headerContainer,i=t&&t.bladeDefinition;return!(!i||!i.tabMenuBlade)}function Be(e){return!(e.menuBlade||e.tabMenuBlade||12===e.style)}function we(e,t,i){e.options.showTranslucentSpinner(!1),i.menuBlade&&(e.clearDetailContent(),t.bladeWidth(2)),i.tabMenuBlade&&e.clearHeaderContent();const n=t.contextMenu,s=n&&n.menuItems;s&&s.splice(0,s().length)}var De;function xe(e){const t=e.effectiveInputs;return t&&t.length&&e.assetIdInputProperty&&e.assetType}function Se(e){const t=e&&e.options,i=t&&t.noticeTmplVm;return!(!i||!i.value)}function ve(e,t,i){let n,s={exists:!1,value:void 0};if(xe(e)){n=MsPortalFx.find(e.effectiveInputs,(t=>t.property===e.assetIdInputProperty));const o=n&&n.valuesFrom,a=o&&o[0]&&o[0].property;a&&1===o[0].referenceType&&(s=(0,A.getModelValue)(t,a),s.exists?s.value=ko.unwrap(s.value):ee.error(`Asset id property '${a}' does not exist in model for composition '${i}'. Model='${pe(t)}'`))}return s}t.create=function(e,t,i){var n,s,o;const a=e.createChildContainer("composition"),r=e.get(h.ViewModelManager).getBladeSequenceNumber(t.locator.getExtensionName(),t.locator.name),l=new Te(a,t.locator,r);l.registerForDispose((()=>a.disposeAsync()));const c={};if(!i)throw new Error("masterContainer is required when creating a blade.");(null===(n=i.bladeDefinition)||void 0===n?void 0:n.tabMenuBlade)&&(l.headerContainer=i,(null===(s=i.masterContainer.bladeDefinition)||void 0===s?void 0:s.menuBlade)&&(i=i.masterContainer)),l.masterContainer=i,l.masterCommandId=t.masterCommandId,l.masterCommandName=t.masterCommandName,l.masterCommandExtension=t.masterCommandExtension,l.masterPartId=t.masterPartId,l.masterInvocationProperty=t.masterInvocationProperty,l.masterInputKeys=t.masterInputKeys,l.masterDetailsDefinition=t.masterDetailsDefinition,l.flags=t.flags,l.telemetryName=t.telemetryName,l.openInitiatedTimestamp=t.timestamp;const p=t.masterPartId?t.masterPartId.split("-"):[],m=t.openedByContext,u=l.openedByInfo;if(l.defaultMenuItemId=t.defaultMenuItemId,l.contentBladeReference=t.contentBladeReference,i.getCompositionType()===x.CompositionType.Startboard){if(p.length)u.openedBy=1;else if(m)switch(m.openedBy){case 1:u.openedBy=2;break;case 2:u.openedBy=5;break;case 3:u.openedBy=6;break;case 4:u.openedBy=3;break;case 5:u.openedBy=7;break;case 6:u.openedBy=8;break;case 7:u.openedBy=9;break;case 8:u.openedBy=10;break;case 9:u.openedBy=11;break;case 10:u.openedBy=12;break;case 11:u.openedBy=13;break;default:u.openedBy=4}u.openedByContext=t.openedByContext,u.openedByPartName=t.masterPartId}const f=e.get(d.DefinitionFinder);return f.tryLocate(t.locator,c)&&(l.bladeDefinition=c.value,l.extension=f.locate(ye(t.locator))),(null===(o=t.locator)||void 0===o?void 0:o.name.toLowerCase().endsWith("_dx"))&&t.model&&(t.model.dxParameters=MsPortalFx.clone(t.model,!0),t.masterInputKeys.push("dxParameters")),l.setInputsViewModel(k.CompositionBinder.createObservableModel(t.model)),l.bindings=t.bindings||[],l.restorationState=void 0===t.flags||4&t.flags?0:1,l},function(e){e[e.ErrorUnrecoverable=1]="ErrorUnrecoverable",e[e.ErrorInitializing=2]="ErrorInitializing",e[e.ErrorLoadingExtension=3]="ErrorLoadingExtension",e[e.ErrorLoadingDefinition=4]="ErrorLoadingDefinition",e[e.ErrorLoadingExtensionAndDefinition=5]="ErrorLoadingExtensionAndDefinition",e[e.ErrorLoadingFramePart=6]="ErrorLoadingFramePart",e[e.FullReadyTimeout=7]="FullReadyTimeout"}(De||(De={}));class Te extends S.Instance{constructor(e,t,i,n={}){super("Blade",e,t,n.children,null,n.id,i),this._diContainer=e,this._disposablesEvents=[],this._partAwaiter=new F.CompositionAwaiter(!0),this._containerAwaiter=new F.CompositionAwaiter,this._bindingResult=ko.observable(),this._disabled=!1,this._rebinding=!1,this._composing=!1,this._initialized=!1,this._callbacks=[$.Callbacks(),$.Callbacks(),$.Callbacks()],this._initialOnInputsSetDeferred=Q.defer(),this._announce=new m.PortalReader(this,{idPrefix:"bladecompo"}),this._bladeViewModelDeferred=Q.defer(),this._compositionDeferred=Q.defer(),this._commandsDeferred=Q.defer(),this._lastInputsSetDeferred=Q.defer(),this._lastInputsSetProperties={},this._perfData={},this._bladeSummaryCollapsed=!1,this._isOpenedByReferrer=ko.observable(!1),this._bladeDefinitionDeferred=Q.defer(),this.bladeDefinitionPromise=this._bladeDefinitionDeferred.promise,this.masterContainer=null,this.headerContainer=null,this.containerType=1,this.masterInputKeys=[],this.masterDetailsDefinition=null,this.bindings=[],this.editScopeId=ko.observable(),this.title=ko.observable(""),this.subtitle=ko.observable(""),this.titleSuffix=ko.observable(),this.subtitleSuffix=ko.observable(),this.description=ko.observable(""),this.helpUri=ko.observable(),this.shieldType=ko.observable(),this.uiBlockers=ko.observableArray([]),this.icon=ko.observable(J.Polychromatic.DefaultBlade()),this.titleImageUri=ko.observable(),this.rebindThrottler=function(){let e,t,i=0;function n(){e&&(e.reject(new H.CanceledError("Throttler cancel pending promise")),clearTimeout(t),e=null)}return{rejectPendingPromise:n,throttle:()=>{const s=Date.now(),o=s-i<he;if(i=s,n(),o){const i=e=Q.defer();return t=setTimeout((()=>{i===e&&(e.resolve(),e=null)}),he),i.promise}return Q()}}}(),this.assetId=ko.observable(),this.restorationState=0,this.openedByInfo={},this.menuDeepLink=ko.observable(),this.fullReadyTime=ko.observable(),this._beforePageUnload=e=>{const t=this.editScopeId(),i=t&&this.diContainer.get(f.EditScopeManager).getStateObservable(t);(this.shouldAlertOnClose()||i&&0!==i())&&(e.preventDefault(),e.returnValue="")},this._childrenCreated=!1,this._viewModelManager=e.get(h.ViewModelManager),this._finder=e.get(d.DefinitionFinder),this._telemetry=new E.BladeTelemetry(e),e.set(E.BladeTelemetry,this._telemetry);const o=this._sequenceNumber=i||(0,h.getNextSequenceNumber)();let a=0;(this._updateRebindSequenceNumber=()=>{this.instanceId=`Blade_${MsPortalFx.sessionId}_${o}_${a++}`})(),e.set(s.CompositionProvenance,new s.CompositionProvenance(t,this.instanceId)),this._shellViewModel={},this.title((0,y.getDefaultTitle)(t&&t.name)),window.addEventListener("beforeunload",this._beforePageUnload),this._compositionDeferred.promise.then((()=>{const e=this.bladeDefinition;if(e&&e.locked){const t=this.getParts();ko.reactor(this,(()=>{const i=t.some((e=>e.triggeringLockedBladeSpinner()));this.containerWidget.options.showTranslucentSpinner(i),this._composing||e.menuBlade||e.tabMenuBlade||(i?this._announce.read(ne.bladeBusy):this._announce.read(ne.bladeReady))}))}})),this.diContainer.get(v.BladeHistory).recordBladeOpened(this)}shouldAlertOnClose(e){return this.children.some((t=>t.children.some((t=>t.shouldAlertOnClose(e)))))}getAlertOnCloseMessages(){const e=[];return this.children.forEach((t=>{t.children.forEach((t=>{const i=t.getAlertMessage();i&&e.push(i)}))})),e}isRestorable(){return 0===this.restorationState&&!Le(this).some((e=>1===e.restorationState))}getViewModel(e,t){let i;const n=this.locator;switch(e=re(e)?1:e){case 1:i=this._shellViewModel;break;case 3:if(!this.isComposed)throw new Error(`Blade '${this}' needs to be composed before retrieving its extension view model.`);this.bladeDefinition.viewModelName||ee.error(`Blade '${n}' does not define an extension view model.`),i=Q.isPromise(this._extensionViewModel)?void 0:this._extensionViewModel;break;case 2:if(!this.isComposed)throw new Error(`Blade '${this}' needs to be composed before retrieving its action bar's view model.`);this.actionBar?i=this.actionBar.getViewModel():(ee.error(`Blade '${n}' does not have an action bar.`),i={});break;case 4:{const e=this._getCommands(),n=(0,x.findCommand)(e,t,this+"");i=n&&n.getViewModel();break}case 999:i={parameters:this._shellViewModel};break;default:ee.error(`Invalid model type '${e}' for blade '${n}'.`)}return i||{}}selectedMenuItemId(){const e=this.menu,t=e&&e.getSelectedItem();return t&&t.id}setDeepLinkContext(t,i,n,o){var a;if(this._perfData.deepLinkContext={deepLinkable:i,length:t.length,reason:n,details:o},!i){let i="Could not create a deep link for the content.";switch(n){case"BladeHasOutputs":return;case"InputsExceedURILength":i+=` The deep link was too long with ${t.length} characters in it.`;break;case"BladeNotPinnableCannotUpgrade_UnsupportedDate":case"UnableToSerializeInputTypeDate":i+=" Input contains a Date type. Date type cannot be roundtripped from JSON without special processing. Either process the Date entry as a string in your inputs, or remove from the inputs.";break;case"UnableToSerializeInputTypeOther":i+=" Input contains a type that cannot be serialized to JSON."}i+=` REASON: ${n} DETAILS: ${o}`,(0,s.logToExtension)(e,Ie(this.locator),2,i,{contextData:{blade:(null===(a=this.locator)||void 0===a?void 0:a.name)||"Unknown_Locator"},diContainer:this.diContainer})}}getDeepLinkContext(){return this._perfData.deepLinkContext}async getDeepLink(e){let t;await this.await(7),this.bladeDefinition.viewModelInputs&&await this.await(4);const i=this.useDetailContent||Me(this),n=(this.useHeaderContent||Pe(this))&&!i;if((!this.useDetailContent&&!this.useHeaderContent||n)&&!(1&this.flags)){const e=this.getInputPropertyBindings();t=(0,g.getDeepLink)(this.diContainer,this.extension.name,this.bladeDefinition,e&&e.targetModel,{assetType:this.assetType,assetId:ko.unwrap(this.assetId),selectedMenuItemId:this.selectedMenuItemId(),setDeepLinkContext:(e,t,i,n)=>this.setDeepLinkContext(e,t,i,n)})}return re(t)&&(this.useDetailContent||!e)&&this.masterContainer?this.masterContainer.getDeepLink():t}getViewModelAsync(e,t){return 1===(e=re(e)?1:e)||999===e?Promise.resolve(this.getViewModel(e)):this._compositionDeferred.promise.then((()=>{if(this.isDisposed())throw new MsPortalFx.Errors.DisposedCanceledError;return 4===e?this._commandsDeferred.promise.then((()=>{const e=this._getCommands(),i=(0,x.findCommand)(e,t,this+"");return i&&i.getViewModelAsync()})):3===e?this._extensionViewModel||Q.reject(new MsPortalFx.Errors.Error("No extension view model loaded")):this.getViewModel(e)}))}setInputsViewModel(e){this._shellViewModel=e;const t=this.bladeDefinition;t&&ce(t.optionalInputs)&&t.optionalInputs.forEach((t=>{e[t]||(e[t]=ko.observable())}))}get isInitialized(){return this._initialized}get eligibleForBinding(){return!0}get journeyPath(){return this._journeyPath||(this._journeyPath=this._buildJourneyPath())}get dirtyAndNotSaving(){return 1===this.diContainer.get(f.EditScopeManager).getStateObservable(this.editScopeId())()}getCompositionType(){return x.CompositionType.Blade}isDefaultTitle(){return(0,y.getDefaultTitle)(this.locator.name)===this.title()}getPermissionPromise(){return this._hasPermissionsDeferred.promise}getInputsOnlyViewModel(){let e=this._shellViewModel;const t=this.bladeDefinition,i=t&&t.outputs;return i&&i.length>0&&(e=MsPortalFx.clone(this._shellViewModel),i.forEach((t=>{delete e[t]}))),e}onAddingContent(e,t){return this.compose(e.getWidget(),t?{index:e.childElementCount.value}:null),Q()}onRemovingContent(e){e.getWidget().clear()}canRemoveContent(){return Ae(this.diContainer).tryCloseBlade(this)}get isDisabled(){return this._disabled}isPinnable(){const e=this.bladeDefinition;return!(!e||!e.pinnable)}isEditable(){const e=this.bladeDefinition;return!(!e||!e.dxSourcePath)}getPinOptions(){let e,t,i,n;const s=Le(this),o=s[0],a=!!(1&this.flags);return 1===s.length&&o.useDetailContent&&o.isPinnable()?(e=a?Q(void 0):this.getDeepLink(),t=o.locator,i=o.getViewModel(),n=o.getOnPinFunction()):(t=this.locator,i=this.getViewModel(),e=Q(void 0),n=this.getOnPinFunction()),Q.all([n,e]).spread(((e,n)=>{const s={deepLink:n,bladeTitle:this.containerWidget.options.title.value,defaultMenuItemId:this.selectedMenuItemId()};return e?MsPortalFx.extend(s,{locator:t,onPin:e}):MsPortalFx.extend(s,{locator:t,model:i})}))}getOnPinFunction(){return Q(this.await(3).then((()=>this.getViewModelAsync(3).then((e=>{const t=e.content();return t&&t._msPortalFxV2ShellApi&&t._msPortalFxV2ShellApi().onPin})))))}static getSourceModified(e){return e.await(3).then((()=>e.getViewModelAsync(3).then((e=>e.container.onSourceModified))))}getAssetInstanceMetadataAsync(){return Q(this.await(7)).then((()=>{const e=this.bladeDefinition;if(xe(e)&&!this.isDisabled&&!this.isDisposed()){const t=ve(e,this._shellViewModel,this.locator.toString());if(t.exists)return{id:t.value,type:this.assetType}}}))}get assetType(){const e=this.bladeDefinition;return e&&e.assetType}offRebind(e,t,i){[e,t,i].forEach(((e,t)=>{e&&this._callbacks[t].remove(e)}))}onRebind(e,t,i){[e,t,i].forEach(((e,t)=>{e&&this._callbacks[t].add(e)}))}save(e){this._composing||this._rebinding||Se(this.widget)||!this.masterContainer||super.save(e)}rebindAsync(e){this._updateRebindSequenceNumber(),O.provideContext((()=>{this._creationState=O.getState()}),N.Blade,Ee(this));const t=this.widget;p.FocusHandler.Instance.registerContainerForFocus(t,this.containerWidget),this.containerWidget.resetInternalState();const i=(0,W.getPortalViewModel)(this.diContainer);let n;const s=(0,x.deepSubset)(this._shellViewModel,e),o=e=>{Re(this,"Rebind COMPLETED."),this._rebinding=!1,this.save(),i.customEvents.trigger("fxbladerebound",{id:this.id}),this.widget.options.loaded(!0),this.diContainer.get(P.CommandState).commandsEnabled(!0),p.FocusHandler.Instance.notifyContainerReadyForFocus(t)};return Re(this,"Rebind STARTED.",e),this._rebindValidationPromise=null,this._waitToRebindPromise=null,this._directoryInfoPromise=null,s?(Re(this,"Updated properties are empty or are equal to the current blade properties. Aborting rebind.",e),this.rebindThrottler.rejectPendingPromise(),o(X.Cancel),n=Q({})):(this._rebinding=!0,this._hasPermissionsDeferred=Q.defer(),this.bladeDefinition&&!this.bladeDefinition.locked&&this.widget.options.loaded(!1),this.diContainer.get(P.CommandState).commandsEnabled(!1),n=this._waitToRebindPromise=this.rebindThrottler.throttle().then((()=>this.isDisposed()?Q.reject(new H.CanceledError("Rebind Canceled. Blade is already disposed."+this)):n===this._waitToRebindPromise?(Re(this,"Rebind after throttle.",e),this._rebindAsync(e).finally((()=>{n===this._waitToRebindPromise&&o(X.Complete)}))):Q.reject(new H.CanceledError("Another rebind already started"))))),n}getTelemetryContextState(){return this._creationState}_rebindAsync(e){const t=this._rebindValidationPromise=this.await(7).then((()=>{if(!this._validateRebindProperties(e))return Q.reject(new MsPortalFx.Errors.CanceledError)})),n=t=>{(0,i.forEachKey)(e,(e=>{(0,A.setModelValue)(this._shellViewModel,e,t?t[e]:void 0)})),t&&(this._journeyPath=this._buildJourneyPath())};return this.useDetailContent||this.containerWidget.clearDetailContent({callback:()=>{const e=this.menu;e&&e.setDefaultId({rebinding:!0})},setPlaceholderDetailContent:!(!this.bladeDefinition.menuBlade&&!this.bladeDefinition.tabMenuBlade||Le(this).length)}),this.useHeaderContent||this.containerWidget.clearHeaderContent(),Q(t.then((()=>{const i=this._bindingsToExtensionViewModel&&this._bindingsToExtensionViewModel.properties.map((e=>e.compositionBindingDefinition)).filter((e=>!!e));this._lastInputsSetDeferred.reject(new MsPortalFx.Errors.CanceledError("New rebind started")),this._lastInputsSetDeferred=Q.defer();const s=(i||[]).filter((e=>!e.optional));if(this._lastInputsSetProperties=(0,A.mapSourceModelToTargetModel)(e,s,1,this+""),function(e,t,i){if(!e)return!1;const n=e.properties.filter((e=>{const t=e.compositionBindingDefinition;return t&&t.source&&1===t.source.modelType}));if(0===n.length)return!1;return n.some((e=>{const n=ko.unwrap(t[e.sourceProperty]),s=ko.unwrap(i[e.sourceProperty]);return!MsPortalFx.deepEquals(n,s)}))}(this._bindingsToExtensionViewModel,this._shellViewModel,e)||this._lastInputsSetDeferred.resolve(),this.isDisposed())return Q.reject(new MsPortalFx.Errors.DisposedCanceledError);if(t&&t!==this._rebindValidationPromise)return Q.reject(new MsPortalFx.Errors.CanceledError("Another rebind has started"));{Re(this,"Updating blade properties.",e);const t=this._callbacks;t[0].fire(e);const i=this._bindingResult()&&this._bindingResult().inputsWatcherConfig;return i&&k.CompositionBinder.turnOnInputsSetSuppressionOn(i),n(void 0),this._clearEditScopeId(),this.setInputsViewModel(this._shellViewModel),(this.bladeDefinition.optionalInputs||[]).forEach((e=>{this._shellViewModel[e](void 0)})),n(e),this._setEditScope(),i&&k.CompositionBinder.turnOnInputsSetSuppressionOff(i),t[2].fire(e),this.bladeDefinition.viewModelInputs||this._hasPermissionsDeferred.resolve(),this._lastInputsSetDeferred.promise.catch((()=>{})).finally((()=>{Re(this,"Inputs set promise completed.",e),this.save(),t[1].fire(e)}))}})))}onDetailContainersChanged(){this._finder.locateAsync(this.locator).then((e=>{this._widgetsCreated&&this._initWidgetFromDefinition(e)}))}_compose(e,t,i){if(this.isComposed||this._composing)return;if(this._composing=!0,this._perfData=this._telemetry.initializeBladeTelemetry(i&&i.assetType,this,ae),this._compositionDeferred.promise.then((()=>{if(t.resolve(),this._perfData.bladeLoadedTime=this.compositionTime=Z()-this._telemetry.readyStartTime,!Se(this.widget))return this._setupCommandBarAndContextMenu()}),(()=>{t.reject()})).then((()=>{this._commandsDeferred.resolve()})),this.unrecoverableErrorMessage)return void this._composeErrorBlade(e,i,De.ErrorUnrecoverable,this.unrecoverableErrorMessage);const n=this.locator,s=this._finder,o=this._viewModelManager.tryEarlyGetViewModel(ye(n).name,n.name,FxImpl.mapValues(this._shellViewModel,ko.unwrap),{menuId:this.defaultMenuItemId,inContextPane:!!(1&this.flags),inSideBar:!!(256&this.flags),isMenuBladeContent:!!U.tryGetParentMenuBlade(this,Ae(this.diContainer).activeJourney()),fetchDefinition:!this.bladeDefinition,sequenceNumber:this._sequenceNumber});o.then((e=>{e.viewModel&&(this._perfData.rpcDurationMs=e.rpcDurationMs,this._perfData.viewModelLoadIndex=e.viewModelLoadIndex)})),this.tryGetVirtualPartViewModel=()=>Q(MsPortalFx.tryImmediateResolve(o,(e=>{const t=e.viewModel;return t&&(this.tryGetVirtualPartViewModel=()=>Q.resolve(null)),t})));const a=this.bladeDefinition?Q(this.bladeDefinition):Q(o).then((()=>s.locateAsync(n)));a.then(this._bladeDefinitionDeferred.resolve),this._getExtensionPerfData();const r=this.extension?Promise.resolve(this.extension):s.locateAsync(ye(n));if(this._shouldShowPendingBlade()){(()=>{const t=this._createNewBladeWidget(e,i);t.element.addClass(de),t.options.close=()=>Ae(this.diContainer).tryCloseBlade(this,1),this._widgetsCreated=!0,this.containerWidget=t,this.widget=t.getContentWidget(),"ResourceMenuBlade"===n.name&&this.containerWidget.setupAsKnownMenuBlade()})()}else{const t=this.masterContainer;t&&t.bladeDefinition&&t.bladeDefinition.menuBlade&&t.bladeDefinition.tabMenuBlade&&(!t.containerWidget.isMenuBladeLoadingDetailBlade()||t.containerWidget.element.hasClass(de))||this._loadingSignalToTopBar(e.element)}a.then((t=>{if(this.bladeDefinition=t,t.menuBlade||t.tabMenuBlade||this._announce.read(ne.bladeLoading),3===this.openedByInfo.openedBy&&!this.isPinnable()&&this.masterInputKeys&&this.masterInputKeys.length){const e=this.openedByInfo.openedByContext.deepLink;e&&/^#(?:[^/]+\/)?blade\//.test(e)&&this._trace({extension:this.extension&&this.extension.name||Ie(n),action:"BladeDeepLinkedNotPinnable",source:"Shell",data:{resource:e}})}this.isDisposed()||(this._initWidgets(t,e,i),this._showLoadingIndicator());let s=De.ErrorLoadingExtensionAndDefinition;return r.then((n=>{s=De.ErrorLoadingDefinition,this.extension=n,!this.isDisposed()&&(4&t.attributes||this._validateParameters(e,t,i))&&this._validateDefinition(e,t,i)&&(this.bindings=this.bindings.concat(k.CompositionBinder.mapInputBindingDefinitions(t.bindings,this,(e=>{e.source.scope===A.ReferenceScope.CurrentContainer&&(e.autoRebindWhenSourceDisposes=!0)}))),this._createChildrenFromDefinition(t),this.save(),this._initialized=!0,this._composeBlade(n,t))})).catch((t=>{this._composeErrorBlade(e,i,s,t)}))})).catch((t=>{let n=De.ErrorLoadingExtensionAndDefinition;a.isRejected()||(n=De.ErrorLoadingExtension),this._composeErrorBlade(e,i,n,t)})).finally((()=>{this._loadedSignalToTopBar()}))}_selectedMenuItemIcon(){let e=null;Me(this)?e=this.masterContainer.menu:Pe(this)&&(e=this.headerContainer.menu);const t=e&&e.getSelectedItem();return t&&ko.unwrap(t.icon)}_shouldShowPendingBlade(){const e=0!=(16&this.flags),t=0!=(1&this.flags);return!Me(this)&&!Pe(this)&&(!e||t)&&!function(e){for(;e;){if(Ue(e))return!0;const t=e.masterContainer;e=t instanceof Te?t:null}return!1}(this)}_loadedSignalToTopBar(){this._loadingHintDisposer&&(this._loadingHintDisposer(),this._loadingHintDisposer=null)}_loadingSignalToTopBar(e){this._loadedSignalToTopBar(),this._loadingHintDisposer=()=>{e.trigger("fxloadingontopbar",{id:this.id,cancel:!0})},e.trigger("fxloadingontopbar",{id:this.id,cancel:!1})}_showLoadingIndicator(){this.widget.options.loaded(!1),this._hasPermissionsDeferred=Q.defer(),Q.allSettled([this._hasPermissionsDeferred.promise,this._compositionDeferred.promise]).finally((()=>{this.widget.options.loaded(!0)}))}_rejectPermissionsPromise(){this._hasPermissionsDeferred?this._hasPermissionsDeferred.reject():this.widget&&this.widget.options.loaded(!0)}_validateRebindProperties(e){let t="";const i=this.bladeDefinition.templateKeyInputs||[];return i.some((t=>!e.hasOwnProperty(t)))?t="Properties to rebind must include all blade inputs marked as keys.":i.some((t=>ce(e[t])))&&(t="Properties to rebind cannot be of Array type."),t&&ee.error(`[Blade Rebind] ${t} Rebind properties:'${ge(e)}', Blade keys:'${ge(i)}'.`),!t}_summaryCollapsed(){let e,t,i=!1;return(this.bladeDefinition.lenses||[]).some((n=>{const s=this.locator.withLens(n.name),o=this._finder.locate(s);return o&&o.isSummary&&o.partInstances&&(i=!0,e=o.partInstances[0],t=s.withPartInstance(e.name)),i})),i?Q(this._sharedSettings.querySetting(2,"[PartIdentityState]-"+t.toString()).then((e=>e?FxImpl.fromSerializableObject(e):null),(()=>null)).then((t=>t&&t.content&&void 0!==t.content.collapsed?!!t.content.collapsed:e.inline&&e.inline.options?!!e.inline.options.collapsed:null))):Q(!0)}_checkIfOpenedByReferrer(e,t){const i=z.ReferrerInfo,n=e.indexOf(i)>-1,s=void 0!==ko.unwrap(t[i]);return n&&s}_composeBlade(e,t){ae&&this._summaryCollapsed(),t.assetType&&this.containerWidget.options.associatedWithAsset(!0);const i=this._journey=Ae(this.diContainer).activeJourney();this.journeyId=i&&i.id||"N/A",this._setupViewModel(),t.editScopeType&&i&&i.observeEditScopeChanges(this,{editScopeId:this.editScopeId,ownerType:this.locator.type,ownerLocatable:this,disposeOnSelectionChange:!1}),this._isOpenedByReferrer(this._checkIfOpenedByReferrer(t.optionalInputs||[],this._shellViewModel)),this._setupInputBindings(),this._setupExtensionViewModel(),this._setupPreviewListener(e,t),this._trackAssetIdChange(),this._waitForNoticeIfAny(t.waitForInputsSet).then((e=>{e&&this._composeAndRestoreLayout().then((()=>{Le(this).forEach((e=>{e.notifyContainer(this)})),this.masterContainer&&this.masterContainer.notifyContainer(this),function(e,t,i){const n=t?t.name:null,s=i?i.assetType:null;let o=1;e.children.forEach((t=>{t.children.forEach((t=>{K.trace({extension:n,source:_e(e.locator),action:"PartPosition",assetType:s,name:_e(t.locator),data:o}),o++}))}))}(this,this.extension,t),this.save(),this.actionBar?this.actionBar.await(7).then((()=>{this._compositionDeferred.resolve()})):this._compositionDeferred.resolve()}),(()=>{this._compositionDeferred.reject()}))})),this.onRebind(),this.containerWidget.bladeDefinitionLoaded=!0,this.containerWidget.trigger("fxbladerepos")}_waitForNoticeIfAny(e){return e?Q(this.await(3)).then((()=>{if(this.isDisposed())return!0;const e=Q(this._extensionViewModel);return MsPortalFx.tryImmediateResolve(e,(e=>{const t=ue(e.container._msPortalFxNotice),i=re(t);return i||this._renderNotice(t),i}))})):Q(!0)}_buildJourneyPath(){const e=this.masterContainer,t=e&&e.journeyPath||[],i={model:{}};return(this.masterInputKeys||[]).forEach((e=>{i.model[e]=ko.unwrap(this._shellViewModel[e])})),t.concat([T.getBladeOpenerJourneyPathSegment(this),MsPortalFx.toSortedString(i),this.locator.toString()])}_createNewBladeWidget(e,t){t=t||{};const s=new y.ViewModel(this.id,this._diContainer,this.widgetState(),{name:this.locator.name,extensionName:Ie(this.locator)});s.asSubJourney=0!=(8&this.flags),s.customHome=Ce(this),s.showMinimize=!!(128&this.flags),(0,i.isFeatureEnabled)("mspinfo")&&this.assetId.subscribeAndRun(this,(e=>{s.directoryInfo(null),e&&(this._directoryInfoPromise=Q(MsPortalFx.require("MsPortalImpl/Services/Services.ProjectedDirectories")).then((e=>this._diContainer.getAsync(e.ServicesProjectedDirectories))).then((t=>t.hasProjectedDirectories().then((i=>{if(i)return t.getDirectoryByResourceId(e).then((e=>{const t=J.StatusBadge;let i=e&&(e.displayName||e.id),o=t.Info();i||(i=n.ResourceFilter.Directory.unknownText,o=t.Unknown()),s.directoryInfo({directoryName:n.Directory.label.format(i),directoryIcon:o})}))})))))}));const o=(0,y.createBladeWidget)($(FxImpl.createElement("section")),s);return 256&this.flags||(t.index>=0?e.insertChild(o,t.index):e.addChild(o)),o}_initWidgets(e,t,i){var n;let s,o;i=i||{};let r=null,l=null;const d=this.masterContainer,c=d&&d.containerWidget,h=this.useDetailContent||Me(this),m=this.useHeaderContent||Pe(this),u=12===e.style,f=!!e.menuBlade,g=!!e.tabMenuBlade,b=0!=(1&this.flags),y=0!=(16&this.flags)&&!b,_=this.useHeaderContent=function(e){return!!e.tabMenuBlade}(e),C=this.useDetailContent=!_&&(h||m)&&Be(e)||y,M=h&&!C,P=Ce(this);if(y||C){s=c,l=new I.ViewModel(this.id,{displayState:s.options.displayState,diContainer:this.diContainer},{name:this.locator.name,extensionName:Ie(this.locator)}),l.applyViewSettings(this.widgetState()),s.options.isMenuBlade(f),s.options.isTabMenuBlade(g);const e=d.selectedMenuItemId&&d.selectedMenuItemId(),t=h&&this.masterContainer.menu||m&&this.headerContainer.menu,i=t&&(null===(n=t.getDefaultItem())||void 0===n?void 0:n.id)||"overview";s.options.isDefaultItemSelected(e===i),s.options.pinEnabled(!1),s.options.pinVisible(!1),s.options.editEnabled(!1),s.options.editVisible(!1),s.options.showFavoriteResourceButton(!1),this.getDeepLink().then((e=>{d.menuDeepLink(e),s.options.deepLink((0,a.getMenuIdFromDeepLink)(e)!==i?(0,a.replaceMenuIdFromDeepLink)(e,i):e)}))}else _?(s=h?c:this.containerWidget,l=new I.ViewModel(this.id,{displayState:s.options.displayState,diContainer:this.diContainer},{name:this.locator.name,extensionName:Ie(this.locator)})):f||g||this.getDeepLink().then((e=>{s.options.deepLink(e)}));y?o=s.openBladeInPlace(this,l):_?o=s.setHeaderContent(l,!h):C?o=s.setDetailContent(l):this._widgetsCreated?(s=this.containerWidget,r=s.options,o=this.widget):(s=this._createNewBladeWidget(t,i),r=s.options,o=s.getContentWidget()),this._widgetsCreated=!0,this.containerWidget=s,this.widget=o,h||(s.options.customHome=P);const B=Ae(this.diContainer).activeJourney();if(B){const e=B.children,t=e[e.length-2],i=t&&t.masterContainer,n=i&&i.containerWidget,s=n&&n.options,o=i&&i.bladeDefinition,a=o&&o.menuBlade&&Be(t.bladeDefinition)&&!s.useActivationStyle;(M||a)&&r&&(r.asSubJourney=!0)}o.options.isV2Blade(Ve(e)),!C&&!_||_&&!h?s.element.data(x.CompositionInstanceDataName,this):o.element.data(x.CompositionInstanceDataName,this),this._attachEventHandlers(s,o,C,_,M,y,h,m,c),this.widgetState(o.saveViewSettings()),u&&o.options.bladeStyle(12);let w=u||C||f||g||P||3===e.width||e.reflowReady;1&this.flags||w||2===e.initialDisplayState||(w=!0,o.options.forcedMaximize(!0));const D=this._perfData.initialDisplayState=w?2:e.initialDisplayState||1;s.options.displayState(D),this._initContainerWidgetFromDefinition(e,s.options),this._initWidgetFromDefinition(e),C&&1===e.initialDisplayState&&o.setContentWidth(),h?s.options.showBladeIcon(!!s.options.associatedWithAsset()):s.options.showBladeIcon(!!e.assetType),o.initializeLayout(),s.initializeLayout({setPlaceholderDetailContent:(f||g&&!h)&&!Le(this).length,hideDefaultContent:g&&!h,callback:e=>{f&&e.addClass(le),g&&e.addClass("fxs-tabmenublade")}}),p.FocusHandler.Instance.registerContainerForFocus(o,s),o.options.locked(e.locked||!1)}_initContainerWidgetFromDefinition(e,t){const i=this.useDetailContent,n=this.useHeaderContent,s=this.masterContainer,o=s&&s.bladeDefinition;o&&o.menuBlade&&!i&&!n&&s.containerWidget.options.displayState(1)}_initWidgetFromDefinition(e){const t=re(e.width)?1:e.width,i=!re(e.reflowReady)&&e.reflowReady;this.containerWidget.options.useActivationStyle=!!e.activationStyle;const n=this.widget.options;if(n.bladeWidth(t),n.bladeStyle(e.style),n.reflowReady(i),1&this.flags){n.displayState(1);const t=e.menuBlade?e.contextPaneWidth||3:e.contextPaneWidth;let i;switch(this.containerWidget.setContextPaneWidth(t),e.style){case 12:i=12;break;case 6:case 8:case 4:case 3:case 9:case 10:i=4;break;default:i=7}n.bladeStyle(i)}}_composeErrorBlade(e,t,i,s){if(this.isDisposed())return;const o=this.locator;this.bladeDefinition=this.bladeDefinition||{name:o&&o.name,lenses:[],locked:!0};const a=s&&s.message||MsPortalFx.getLogFriendlyMessage(s)||"N/A",{data:r,stack:l}=s,d=Object.assign(Object.assign({details:a,resourceId:this._findResourceId()},r),{stack:l});this._telemetry.traceBladeLoadErrored(De[i],d);const c=`Blade '${this}' has been turned to error mode. Details: ${a}`;ee.error(c,void 0,d),this._widgetsCreated||this._initWidgets(this.bladeDefinition,e,t);const h=this.containerWidget,p=h.options;p.locked(!0),p.titleImageUri(void 0),this._renderError({message:n.PartError.titleContent,summaryItems:[{label:n.PartError.errorReason,value:De[i]}],details:s},{bladeTitle:ie.error}),this._compositionDeferred.reject(new MsPortalFx.Errors.CanceledError(c)),this._rejectPermissionsPromise(),this._announce.read(ne.bladeError),h.bladeDefinitionLoaded=!0,h.trigger("fxbladerepos")}disableForAssetDeleted(e,t){if(this.useDetailContent)return void this.masterContainer.disableForAssetDeleted(e,t);const i=`Blade ${this} ${e?"closed":"disabled"} because asset deleted. Reason: ${t}`;if(e)ee.warning(i),Ae(this.diContainer).forceCloseBlade(this);else{for(let e=this.children.length-1;e>=0;e--)this.removeChild(this.children[e]);const e=this.containerWidget,t=e&&e.options;t&&t.titleImageUri(void 0),this._renderError({message:te.deletedSubTitle,code:410},{bladeTitle:te.deletedTitle}),this.bindings=[],this._compositionDeferred.reject(),this._rejectPermissionsPromise(),ee.warning(i)}this.save()}resetLayout(e){return Q(this.await(7).then((()=>{const t=Le(this)[0];if(t&&t.useDetailContent)return t.resetLayout(e);const i=this.diContainer;let n;if(e)n=Q(6);else{const e=new b.MessageBox(ie.resetConfirmationTitle,ie.resetConfirmationText,4);n=Q(i.getAsync(b.DialogManager)).then((t=>t.showDialog(e,this.widget,this.widget.element[0],{locator:this.locator})))}return n.then((e=>{if(6===e){if(!Ae(i).discardEditsOfBlade(this,{includeSelf:!0,includeDescendants:!0,force:!0}).successful)return void ee.error(`Unexpectedly failed to discard changes on the blade with id: '${this.id}'`);if(!Ae(i).closeChildBlades(this).successful)return void ee.error(`Unexpectedly failed to close child blades of the blade with id: '${this.id}'`);this.widget.options.loaded(!1),this.children.forEach((e=>{e.children.forEach((e=>{e.clearIdentitySettings()}))})),this.removeChildren(),this._childrenCreated=!1,this._createChildrenFromDefinition(this.bladeDefinition),this._removeRedirectParts(),this._composeChildren(),this.save(),this.widget.options.loaded(!0)}}))})))}_setupCommandBarAndContextMenu(){const e=this.widget.options,t=this.bladeDefinition;fe(this._commandBarLifetime);const i=this._commandBarLifetime=this.createChildLifetime();return Q((0,M.create)(i,this,this.diContainer,this._shellViewModel).then((()=>{this._composeShellCommands(e.contextMenu.menuItems,t.locked,e.displayState),i.registerForDispose((()=>{e.commandBar.menuItems([]),e.commandBar.items([]),e.contextMenu.menuItems([])}))})))}_setupInputBindings(){k.CompositionBinder.setupPropertyBindings(this.diContainer,this,this.getInputPropertyBindings(),this.bindings),this.getInputPropertyBindings().addPropertyChangedHandler((()=>{this.save()}))}getMenuWidget(){return this.menu}getComposedParts(){return this._partAwaiter.resolvedCompositions}getParts(){return MsPortalFx.mapMany(this.children,(e=>e.children))}getInputPropertyBindings(){return this._inputPropertyBindings||(this._inputPropertyBindings=new A.PropertyBindings(this+"",this._shellViewModel)),this._inputPropertyBindings}awaitComposedPart(e,t){return this._partAwaiter.await(e,t)}notifyPartComposed(e){this._partAwaiter.resolve(e)}getWaitingCompositions(){return this._partAwaiter.waitingCompositions}await(e){switch(e){case 3:return this._lastInputsSetDeferred.promise;case 4:return this._initialOnInputsSetDeferred.promise}return super.await(e)}resolveInitialOnInputsSet(){this._initialOnInputsSetDeferred.resolve()}dispose(e){window.removeEventListener("beforeunload",this._beforePageUnload),this._telemetry.beginTraceBladeDisposed(),this._releaseResources(e),this.masterContainer&&!this.masterContainer.isDisposed()&&this.masterPartId&&MsPortalFx.tryImmediateResolve(this.masterContainer.awaitComposedPart(null,(0,x.getIdMatchFunc)(this.masterPartId)),(e=>{e.notifyDetailBladeClosed(this)})),super.dispose(e),this._telemetry.endTraceBladeDisposed(),Me(this)||this._announce.read(ne.bladeClosed),this._loadedSignalToTopBar()}_releaseResources(e){fe(this._disposablesEvents),this._disposablesEvents=[],[this._inputPropertyBindings,this._bindingsToBladeWidgetModel,this._bindingsToExtensionViewModel].forEach((e=>{e&&(e.unbind(),e=null)})),e||this._disposeEditScopes(),this._extensionViewModel&&this.extension&&MsPortalFx.tryImmediateResolve(Q(this._extensionViewModel),(e=>{this._viewModelManager.releaseViewModel(e),this._extensionViewModel=Q.reject(new MsPortalFx.Errors.DisposedCanceledError)})),this._callbacks.forEach((e=>{e.empty()})),this._journey=null}awaitContainer(e,t){return this._containerAwaiter.await(e,t)}onInvocationStarted(){}notifyContainer(e){this._containerAwaiter.resolve(e)}getDiagnosticsData(){return $.extend(super.getDiagnosticsData(),{title:pe(this.title),detailBlades:Le(this).map((e=>e.id)),bindings:k.CompositionBinder.mapBindingsToFriendlyObjects(this.bindings)})}getAssetId(){if(!this.bladeDefinition||!this.bladeDefinition.assetIdInputProperty)return Q.reject();const e=e=>{const t=this._tryGetAssetIdFromBinding();t&&t.exists?e.resolve(ko.unwrap(t.value)):e.reject()},t=this._bindingResult,i=i=>{t().allInputsSet()?e(i):t().allInputsSet.subscribe(this,(t=>{t&&!i.promise.isFulfilled()&&e(i)}))},n=Q.defer();return t()?i(n):t.subscribe(this,(e=>{e&&!n.promise.isFulfilled()&&i(n)})),n.promise}setViewModelForTemplateOrMenuBlade(e){this._bladeViewModelDeferred.resolve(e)}setInputsSetPromise(e){e.finally((()=>{this._initialOnInputsSetDeferred.resolve(),this._lastInputsSetDeferred.resolve()}))}logFrameBladeLoadError(e){this._trace({action:"IFrameBladeTimeout",data:{details:e}})}_trace(e){const t=this.locator,i=t&&ye(t),n=i&&i.name;K.trace({extension:e.extension||n,source:e.source||"Shell",action:e.action,actionModifier:e.actionModifier,name:e.name||_e(t),data:e.data,journeyId:this.journeyId,duration:e.duration})}_trackAssetIdChange(){if(this.bladeDefinition.menuBlade){const e=MsPortalFx.find(MsPortalFx.mapMany(this.children,(e=>e.children)));ko.reactor(this,(()=>{this.assetId(e.assetId())}))}else(0,x.bladeImplementedWithVirtualPart)(this.bladeDefinition)?ko.reactor(this,(()=>{const e=ve(this.bladeDefinition,this._shellViewModel,this.locator.toString());e.exists&&this.assetId(e.value)})):ko.reactor(this,(()=>{const e=this._bindingResult();if(e&&e.allInputsSet()){const e=this._tryGetAssetIdFromBinding();e&&e.exists&&this.assetId(ko.unwrap(e.value))}}))}_tryGetAssetIdFromBinding(){const e=MsPortalFx.find(this._bindingResult().propertyBindings.properties,(e=>e.targetProperty===this.bladeDefinition.assetIdInputProperty));return e?(0,A.getModelValue)(e.sourceModel,e.sourceProperty):null}_setupViewModel(){(this.bladeDefinition.outputs||[]).forEach((e=>{this._shellViewModel.hasOwnProperty(e)||(this._shellViewModel[e]=ko.observable(void 0))})),this._setEditScope()}_setEditScope(){if(!this.bladeDefinition.editScopeType)return;const e=this._journey&&this._journey.ambientSettings.getItem(this.journeyPath);e&&e.value&&e.value.editScope?this.editScopeId(e.value.editScope.editScopeId):(this.editScopeId((0,i.getUniqueId)()),this.diContainer.get(f.EditScopeManager).onEditScopeCreated(this.editScopeId())),this._shellViewModel[x.EditScopeIdPropertyName]||(this._shellViewModel[x.EditScopeIdPropertyName]=ko.observable()),this._shellViewModel[x.EditScopeIdPropertyName](this.editScopeId())}_updateForHasPermissions(e){return Q(this.getViewModelAsync(3).then((t=>{if(this.isDisposed())ee.warning(`Blade '${this.locator.toString()}' disposed when checking permissions.`);else{const i=t.container;if(e)!MsPortalFx.isNullOrUndefined(ue(i.unauthorizedMessage))&&i.unauthorizedMessage(null),this._hasPermissionsDeferred.resolve();else{const e=i.unauthorized();e&&e.finally?e.finally((()=>{this._hasPermissionsDeferred.reject()})):this._hasPermissionsDeferred.reject()}}})))}_setupExtensionViewModel(){const e=this.widget;let t,i;const s=this.bladeDefinition,o=(0,x.bladeImplementedWithVirtualPart)(s),a=e=>(t=this._createBindViewModelConfiguration(e),i=k.CompositionBinder.createBindViewModelResult(this.diContainer,t),i);if(s.viewModelName||s.viewModelLocator||o){const r=`${this}-[${s.viewModelName}]`,d=s.viewModelInputs;let c=Q(null);d&&(a(r),i.inputsWatcherConfig&&(c=Q(k.CompositionBinder.loadOnInputsSetParameters(i.inputsWatcherConfig)))),this._extensionViewModel=c.then((e=>{d&&(this.earlyOnInputsSet=!!e);const t=O.provideContext((()=>(this._creationState=O.getState(),o?this._bladeViewModelDeferred.promise:this._viewModelManager.getViewModel(this.extension.name,s.viewModelLocator||s.viewModelName,68,{onInputsSetParameters:e}))),N.Blade,Ee(this));return O.provideContext((()=>{this._masterBladeState=O.getState()}),N.Blade,this.masterContainer?Ee(this.masterContainer):null),e?t.then((t=>(k.CompositionBinder.notifyOnInputsSetCalled(i.inputsWatcherConfig,e,t.onInputsSetPromise),t))):t})).then((e=>{const c=this+"-[WidgetModel]",h=e.content();this._extensionViewModel=e;const p=ko.unwrap(e.onInputsSetPromiseState);if(p&&(this._perfData.onInputsSetPromiseState=p.state,this._perfData.onInputsSetPromiseType=U.OnInputsSetPromiseType[p.type]),this.isDisposed())return this._releaseResources(),Q.reject(new MsPortalFx.Errors.DisposedCanceledError);if(!this.isDisabled){const p=e.container;ko.reactor(this,[p.notFoundMessage,p._msPortalFxHandledError,p.unauthorizedMessage],(()=>{const e=p.notFoundMessage(),t=p._msPortalFxHandledError(),i=p.unauthorizedMessage();if(MsPortalFx.isNullOrWhiteSpace(function(e){if(MsPortalFx.isNullOrUndefined(e)||MsPortalFx.isNullOrUndefined(e.message))return e;{const t=e.message;return"string"==typeof t?t:t.htmlTemplate}}(e)))if(re(i))re(t)||this._renderError(t,{});else{const e=this.widget.options,t=te.unauthorizedMessage,n=e.subtitle(),s=MsPortalFx.isObject(i),o=s?i:{},a=s||i===MsPortalFx.Resources.Strings.ViewModels.Container.unauthorizedText?o.noticeDescription||te.unauthorizedDescription:i,r={noticeHeader:o.noticeHeader||te.unauthorizedHeader,noticeTitle:o.noticeTitle||te.unauthorizedMessage,noticeDescription:a,noticeCallToActionText:o.noticeCallToActionText||"",noticeCallToActionUri:o.noticeCallToActionUri||"",noticeImageType:l.ImageType.Unauthorized,bladeTitle:t,bladeSubtitle:n,shouldDisableBlade:!0},d={bladeTitle:t,bladeSubtitle:n,fallbackErrorCode:403};if("string"==typeof i)this._renderError(i,d);else if(re(i.message)){const e="<p class='msportalfx-notice-header' data-bind='text: $data.noticeHeader'></p><p class='msportalfx-notice-title' data-bind='text: $data.noticeTitle'></p><p class='msportalfx-notice-description' data-bind='sanitizedHtml: $data.noticeDescription'></p><a class='msportalfx-notice-action' target=\"_blank\" data-bind='attr: { href: $data.noticeCallToActionUri }, visible: $data.noticeCallToActionUri'><span class='msportalfx-notice-secondary-action-text' data-bind='text: $data.noticeCallToActionText'></span></a>";this._renderError({message:{htmlTemplate:e,viewModel:r}},d)}else this._renderError(i,d)}else{const{notFound:t}=n.Container;this._renderError(e,{bladeTitle:t,bladeSubtitle:"",fallbackErrorCode:404})}})),d||o||(this._initialOnInputsSetDeferred.resolve(),this._lastInputsSetDeferred.resolve()),d?(t||a(r),t.bindableTarget.viewModel=e,i.inputsWatcherConfig&&k.CompositionBinder.setupAllInputsSetWatcherFromExtendedConfig(i.inputsWatcherConfig),this._bindingsToExtensionViewModel=i.propertyBindings,this._bindingResult(i)):this._hasPermissionsDeferred.resolve();const m=this.containerWidget.options,f=this.widget.options,g=this._bindingsToBladeWidgetModel=new A.PropertyBindings(c,{title:f.title,subtitle:f.subtitle,titleSuffix:f.titleSuffix,subtitleSuffix:f.subtitleSuffix,description:f.description,helpUri:f.helpUri,icon:f.icon,titleImageUri:m.titleImageUri,contentState:f.contentState,contentStateDisplayText:f.contentStateDisplayText});let b,_;ko.reactor(this,(()=>{f.shieldType(this.shieldType())})),ko.reactor(this,(()=>{f.isUiBlocked(this.uiBlockers().some((e=>e())))}));const C=this._selectedMenuItemIcon();Ve(s)?(b=function(e,t,i){const n=ko.observable();function s(e){n(e||null)}const o=e.bladeDefinition;return ko.reactor(e,(()=>{const n=ko.unwrap(t.icon);if(n)s(n);else if(i)s(i);else if(o.assetType){let t;if(t=e.assetId()){const i=e.extension,n={assetId:t,assetType:o.assetType,extensionName:i.name};Q.delay(1).then((()=>e.diContainer.get(u.AssetTypeService).mapAssetIdToDynamicSelectionAndIcon(n,"BladeIcon"))).then((e=>{s(e&&e.icon||I.defaultSvg)})).catch((()=>{s(I.defaultSvg)}))}else s(I.defaultSvg)}else s()})),{icon:n}}(this,h,C),_=null):(b=h,C&&ko.isObservable(b.icon)&&MsPortalFx.deepEquals(b.icon(),I.defaultSvg)&&b.icon(C),_=I.defaultSvg);const M=y.widgetProperties;ke(g,r,h,M.title,this.title,(0,y.getDefaultTitle)(this.locator.name)),ke(g,r,h,M.subtitle,this.subtitle,""),ke(g,r,h,M.titleSuffix,this.titleSuffix,"","titleSuffix",!0),ke(g,r,h,M.subtitleSuffix,this.subtitleSuffix,"","subtitleSuffix",!0),ke(g,r,h,M.description,this.description,""),ke(g,r,h,M.helpUri,this.helpUri,""),ke(g,r,b,M.icon,this.icon,_),ke(g,r,h,M.titleImageUri,this.titleImageUri,void 0),h.statusBar?this._onStatusBarClick=function(e,t,i,n){let s,o,a=!1;const r=ko.observable(),l=t=>{let l=!1;const d=t.onClick||t.onActivated;o&&(o.dispose(),o=void 0,s=void 0);const c=MsPortalFx.find(Le(e),(t=>t.masterCommandName===se.format(e.bladeDefinition.name)&&t.masterPartId===e.id));if(c&&Ae(e.diContainer).forceCloseBlade(c),t.selection){l=!0,o=e.createChildLifetime(),s=(0,P.createOpenBladeCommand)(o,e.diContainer,e,e.bladeDefinition,e.extension,se.format(e.bladeDefinition.name)),r(s.viewModel.container),r().selectable.selectedValue(t.selection);const i=!Le(e).length;n()&&i&&!a&&(s.execute(!1),a=!0)}else d&&d.uri?(l=!0,o=e.createChildLifetime(),s=(0,P.createOpenLinkCommand)(o,e.diContainer,e,e.bladeDefinition,e.extension,se.format(e.bladeDefinition.name),d)):t.onClick&&(l=!0);i.contentState(t.state),i.contentStateDisplayText(t.text),i.statusBar.activatable(l)},d=e=>{e&&0!==e.state||(e={text:"",state:0,selection:null}),l(e)};return t.subscribeAndRun(e,d),ko.reactor(e,(()=>{const e=r()&&r().selectable.isSelected(),n=ue(t);i.statusBar.activated(e),e&&n&&"function"==typeof n.onActivated&&n.onActivated()})),()=>{s&&s.execute(!1);const e=ue(t);if(e){const t=e.onClick;t&&("function"==typeof t?t():"function"==typeof t.onLinkOpened&&t.onLinkOpened(!1))}}}(this,h.statusBar,this.widget.options,this._isOpenedByReferrer):(ke(g,r,h,M.contentState,ko.observable(0),0),ke(g,r,h,M.contentStateDisplayText,ko.observable(""),"")),ko.reactor(this,(()=>{const e=f.icon(),t=Ve(s)?!e:MsPortalFx.deepEquals(e,I.defaultSvg);f.hasIcon(!t)}))}return e})).catch((t=>{const i=`Unable to get extension view model for blade '${this.locator.toString()}'. Error: ${MsPortalFx.getLogFriendlyMessage(t)}`;return H.Error.isBaseOf(t)&&0===t.errorLevel||ee.error(i),e.options.title((0,y.getDefaultTitle)(this.locator.name)),this._hasPermissionsDeferred.resolve(),Q.reject(new H.CanceledError(i))}))}else e.options.title((0,y.getDefaultTitle)(this.locator.name)),this._initialOnInputsSetDeferred.resolve(),this._hasPermissionsDeferred.resolve()}_createBindViewModelConfiguration(e){return{bindableTarget:{viewModelName:e},inputs:this.bladeDefinition.viewModelInputs,referenceComposition:this,inputsSetCalled:(e,t)=>{t.finally((()=>{($.isEmptyObject(this._lastInputsSetProperties)||(0,x.deepSubset)(e,this._lastInputsSetProperties))&&this._lastInputsSetDeferred.resolve(),this._initialOnInputsSetDeferred.resolve()}))},customInputBindingValidator:e=>{if(1!==e.valuesFrom[0].referenceType&&5!==e.valuesFrom[0].referenceType&&!e.optional)return"Blade view model binding can only use 'BladeInput' and 'Constant' reference types."},beforeViewModelPropertyUpdate:e=>{const t=this.bladeDefinition;if((t.optionalInputs||[]).forEach((t=>{void 0===e[t]&&delete e[t]})),t.permissions&&!(0,x.bladeImplementedWithVirtualPart)(t)){const i=this.locator.toString();return(0,L.checkPermissions)(t.permissions,G.All,e,t.assetType,this.extension.name,this.diContainer,i).then((e=>(this._updateForHasPermissions(e).then(null,(e=>{ee.error(e)})),e)))}return this._hasPermissionsDeferred.resolve(),Q(!0)}}}_setupPreviewListener(e,t){const i=this.containerWidget.options;if(this.diContainer.get(c.ManifestCache).getManifest(e.name,"assetTypes").isPreview)i.showPreviewTag(!0);else if(t.assetType){const n=this.diContainer.get(u.AssetTypeService);Y(n.assetTypesComplete,(()=>{const s=n.getAssetType(e.name,t.assetType);s&&i.showPreviewTag(s.isPreview)}))}else Q(this._extensionViewModel).then((e=>{if(e){const t=e.container;t.preview.subscribe(this,i.showPreviewTag),i.showPreviewTag(t.preview())}}))}_renderNotice(e){if(!(0,x.bladeImplementedWithVirtualPart)(this.bladeDefinition))for(let e=this.children.length-1;e>=0;e--)this.removeChild(this.children[e]);const t=this.containerWidget;if(t&&t.options){const i=this.widget.options;i.contentState(0),i.contentStateDisplayText(""),void 0!==e.bladeTitle&&i.title(e.bladeTitle),void 0!==e.bladeSubtitle&&i.subtitle(e.bladeSubtitle),i.titleSuffix(""),i.subtitleSuffix(""),we(t,i,this.bladeDefinition);const n=new l.ViewModel(this.widget.ltm||this);n.header(e.noticeHeader),n.title(e.noticeTitle),n.description(e.noticeDescription),n.imageType(e.noticeImageType),n.callToActionText(e.noticeCallToActionText),n.callToActionUri(e.noticeCallToActionUri),i.noticeTmplVm(n),p.FocusHandler.Instance.notifyContainerReadyForFocus(this.widget)}e.shouldDisableBlade&&(this._disabled=!0,this.bindings=[],this._releaseResources()),this._compositionDeferred.resolve()}_renderError(e,t){var i;const n=this.locator;if(this.bladeDefinition=this.bladeDefinition||{name:n&&n.name,lenses:[],locked:!0},!(0,x.bladeImplementedWithVirtualPart)(this.bladeDefinition))for(let e=this.children.length-1;e>=0;e--)this.removeChild(this.children[e]);let s;s="string"==typeof e?{message:e}:e;const o=this.containerWidget;(null===(i=this.bladeDefinition)||void 0===i?void 0:i.menuBlade)&&(null==o||o.element.removeClass(le));if(o&&o.options){const e=this.widget.options;(a=e).subtitle(""),a.titleSuffix(""),a.subtitleSuffix(""),a.description(""),a.helpUri(""),a.contentState(0),a.contentStateDisplayText(""),a.disabled(!0),we(o,e,this.bladeDefinition),void 0!==t.bladeTitle&&e.title(t.bladeTitle),void 0!==t.bladeSubtitle&&e.subtitle(t.bladeSubtitle);const i=new _.ViewModel(s,{sessionId:MsPortalFx.sessionId,extName:this.extension&&this.extension.name||this.locator&&this.locator.getExtensionName(),contentName:n&&n.name,resourceId:this._findResourceId(),code:t.fallbackErrorCode}),r=new P.CompositionInstanceCommandContext($(this.containerWidget.element)[0],null,this),l=new w.GoToAssetBlade(this,this._diContainer,this);l&&(l.bind(r),l.enabled()&&i.commands.push(l)),e.errorTmplVm(i),p.FocusHandler.Instance.notifyContainerReadyForFocus(this.widget)}var a;this.getDeepLink().then((e=>{e&&e!==location.href&&(0,r.pushState)({data:{},url:e})})),this._disabled=!0,this._releaseResources()}_disposeEditScopes(){const e=this.editScopeId();e&&this.diContainer.get(f.EditScopeManager).onEditScopeDisposed(e);const t=this._journey;if(t){const e=this.journeyPath;t.ambientSettings.getItemsInPath(e).forEach((e=>{e.value&&e.value.editScope&&this.diContainer.get(f.EditScopeManager).onEditScopeDisposed(e.value.editScope.editScopeId)})),t.ambientSettings.removeItemsInPath(e)}}_clearEditScopeId(){if(!this.bladeDefinition.editScopeType)return;const e=this.editScopeId(),t=e&&this.diContainer.get(f.EditScopeManager).getStateObservable(e);t&&0===t()&&this.diContainer.get(f.EditScopeManager).onEditScopeDisposed(e),this.editScopeId(void 0),this._shellViewModel[x.EditScopeIdPropertyName](void 0)}_createChildrenFromDefinition(e){if(!this._childrenCreated){if(e.lenses){const t=[];e.lenses.forEach((i=>{const n=this.locator.withLens(i.name),s=V.create(this.diContainer,n,e.locked&&this._sequenceNumber);i.isSummary?t.unshift(s):t.push(s)})),this.addChildren(t)}this._childrenCreated=!0}}_removeRedirectParts(){this.children.filter((e=>{const t=e.children.filter((e=>{const t={};return this._finder.tryLocate(e.locator,t)&&!!t.value.redirectMode})),i=e.children.length&&t.length===e.children.length;return t.forEach((t=>{e.removeChild(t)})),i})).forEach((e=>{this.removeChild(e)}))}_composeChildren(e=this.children){const t=[],n=[],s=this._summaryCollapsed();let o,a=0;if((0,i.isFeatureEnabled)("bladefullreadytimeout")){a=setTimeout((()=>{const e=MsPortalFx.extend({resourceId:this._findResourceId(),partStates:o},this._perfData);this._trace({action:"BladeLoadErrored",actionModifier:De[De.FullReadyTimeout],data:e,duration:a})}),E.bladeFullReadyTimeout)}e&&e.length&&e.forEach((e=>{s.then((i=>{this._bladeSummaryCollapsed=i,e.compose(this.widget),t.push(e.await(7)),n.push(e.await(3)),e.children.concat([e]).forEach((e=>{t.push(e.await(7)),n.push(e.await(3))}))}))})),s.finally((()=>{Q.all(t).then((()=>{this._perfData.bladeOpenedTime=Z()-this._telemetry.readyStartTime})).finally((()=>{this._composing=!1,this.save()})),be(this,Q.allSettled(n)).then((e=>{o=e,this._telemetry.traceBladeComplete(e,a,Me(this)),p.FocusHandler.Instance.notifyContainerReadyForFocus(this.widget)})),Q.all(n).then((e=>{this.bladeDefinition.menuBlade||this.bladeDefinition.tabMenuBlade||this._announce.read(ne.bladeReady)})),Q.allSettled(n).then((()=>{const e=this.getParts();Q.allSettled([...e.map((e=>this.notifyPartComposed(e)))]).then((()=>{this.containerWidget.options.printEnabled(e.every((e=>{let t=!0;if(e.definitionExists){const i=MsPortalFx.Parts.PartKind,n=e.partDefinition&&e.partDefinition.partKind;t=n!==i.Frame&&n!==i._Internal_App&&n!==i._Internal_Az}return t})))}))}))}))}getPerfData(){return MsPortalFx.extend2(this._perfData,this.menu&&this.menu.getTelemetryInfo())}_composeAndRestoreLayout(){const e=this.containerWidget;this._removeRedirectParts(),this._composeChildren();let t=Q();const i=this.bladeDefinition.actionBar;if(!this._rebinding&&i){const e=this.locator.withBladeActionBar(i.name);t=Q(MsPortalFx.tryImmediateResolve(MsPortalFx.require("MsPortalImpl/UI/Compositions/UI.Composition.BladeActionBar"),(t=>{const i=this.actionBar=t.create(this.diContainer,e);i.parent=this,i.compose(this.widget),this.registerForDispose(this.actionBar)})))}return 2===e.options.displayState()&&e.refreshDisplayState(),t}_getCommands(){if(!this.isComposed||!this.widget)throw new Error(`Blade '${this}' needs to be composed before retrieving its commands.`);return this.widget.options.commandBar.menuItems()}_attachEventHandlers(e,t,i,n,s,o,a,r,l){const d=e.element,c=t.element,h=e.options;if(i)r||!l||o||l.clearHeaderContent();else{if(c.on("fxregistermenu",((t,i)=>{const n="Default",s=_e(this.locator);i.onItemClick(((e,t)=>{this._trace({action:"MenuItemClick",actionModifier:n,data:$.extend({blade:s,type:i.getResourceType()||this.assetType},t),source:"Blade",name:e})})),i.setDefaultId({recommendedId:this.defaultMenuItemId,bladeReference:this.contentBladeReference}),i.onSearchMiss((e=>{O.usingState((()=>{this._trace({action:"MenuBladeSearchMiss",actionModifier:n,data:$.extend({blade:s,type:i.getResourceType()||this.assetType},e),source:"Blade"})}),this._creationState)})),this.await(4).finally((()=>{const e=i.getResourceType()||this.assetType;O.usingState((()=>{const t=$.extend({blade:_e(this.locator),type:e},i.getTelemetryInfo());this._trace({action:"MenuBladeInfo",actionModifier:n,data:t,source:"Blade"})}),this._creationState),e&&h.associatedWithAsset(!0)})),ko.reactor(this,(()=>{e.options.titleSuffix(i.selectedItemText())})),this.menu=i})),!a||!n){let t;h.close=()=>{const e=Ae(this.diContainer),t=e.tryCloseBlade(this,1);if(t){const t=e.activeJourney();if(t){const e=t.children,i=e[e.length-1];s&&i.menu.selectDefaultItem();this.containerWidget.options.favoriteResourceButton.configure(i.masterContainer,i.containerWidget.options)}}return t},h.pinblade=()=>{t&&t.dispose(),t=this.createChildLifetime();const i=new B.Pin(t,this.diContainer);i.bind(new P.CompositionInstanceCommandContext(e.element[0],(()=>Q(e.getContentWidget())),this)),i.execute(!1)};const i=new B.Edit(this.createChildLifetime(),this.diContainer,(e=>{h.editState(e)}));h.editblade=()=>{i.bind(new P.CompositionInstanceCommandContext(e.element[0],(()=>Q(e.getContentWidget())),this)),i.execute(!1)},h.resetEditCommand=()=>{i.reset()}}a&&l&&!n&&(l.clearHeaderContent(),l.clearDetailContent())}t.options.commandBar.itemSelected=(e,i)=>{const n=i.item;if(n&&n.enabled()&&!n.unauthorized()){const e=i.popupTarget,s=e?{getForm:()=>e,showForm:MsPortalFx.noop,hideForm:MsPortalFx.noop}:t;n.bind(new P.CompositionInstanceCommandContext(t.element[0],(()=>Q(s)),this)),n.execute(!1);const o=i.item.commandDefinition;o&&o.details&&Fe(this,(e=>e.masterCommandName===o.name))}},t.options.commandBar.locator=this.locator,this._disposablesEvents.push(c.setEvents([C.Widget.viewSettingsChanged,(e,t)=>{this.widgetState(t),this.save(1),e.stopPropagation()}],["fxbladestatusbarclicked",e=>{this._onStatusBarClick&&this._onStatusBarClick()}]),d.setEvents(["fxensurebladevisible",(e,t)=>{Fe(this,(e=>!e.masterCommandName&&e.masterPartId===t.masterPartId))}],["fxsummarycollapsed",(e,t)=>{t.collapsed=this._bladeSummaryCollapsed}],["fxgotodefaultitem",e=>{this.menu&&this.menu.selectDefaultItem()}]))}_composeShellCommands(e,t,i){const n=[],s=this.diContainer,o=this.containerWidget.options;if(this.isPinnable()){const e=this.bladeDefinition,t=(0,x.getBladeType)(e),i=5===t||6===t,n=new B.Pin(this,s);o.pinVisible(!i),e&&e.hasOnPinMethod?this.getOnPinFunction().then((e=>{e&&(i&&o.pinVisible(!0),n.activate(),o.pinEnabled(!0))})):(n.activate(),o.pinEnabled(!0))}o.favoriteResourceButton.configure(this.masterContainer,o),o.resetEditCommand&&o.resetEditCommand(null),this.isEditable()&&(o.editVisible(!0),o.editEnabled(!0)),n.push((0,B.getDisplayStateCommand)(s,1),new B.ResetLayout(this,s,t,i)),me.arrayPushAll(e,n)}_validateParameters(t,i,n){const o=this.getViewModel(),a=(i.inputs||[]).filter((e=>!(0,A.getModelValue)(o,e).exists));if(a.length){let i;if(this.masterPartId){const t=MsPortalFx.find(this.masterContainer.getComposedParts(),(0,x.getIdMatchFunc)(this.masterPartId)),n=this.diContainer.get(R.Finder).findPartsContainer(t),o=t&&t.partDefinition&&t.partDefinition.shareVmWithParentBlade?n&&n.locator:t&&t.locator;i=`The ${1===o.type?"blade":"part"} ${_e(o)} failed to supply all the required parameters. The missing the required parameter(s) '${a.join(", ")}'.`;const r=`Failed to open the blade ${_e(this.locator)}. ${i}`;(0,s.logToExtension)(e,Ie(o),2,r)}else i=`The link '${this.openedByInfo.openedByContext.deepLink}' is missing the required parameter(s) '${a.join(", ")}'.`;this._composeErrorBlade(t,n,De.ErrorInitializing,i)}return!a.length}_validateDefinition(e,t,i){let n=!0;const s=[],o="A blade cannot be the owner of an edit scope and also receive an edit scope id from an external source.";return t.assetType&&!t.assetIdInputProperty?(s.push("'assetIdInputProperty' is required if 'assetType' is defined on blade definition."),n=!1):t.inputs&&t.outputs&&(n=!t.inputs.some((e=>{const i=t.outputs.indexOf(e)>=0;return i&&s.push(`Property '${e}' cannot be marked as input and output.`),i}))),n=n&&k.CompositionBinder.validateInputBindings(this,t.bindings,s,(e=>1===e.valuesFrom[0].referenceType?"Blade bindings cannot reference BladeInputs.":ce(t.inputs)&&t.inputs.indexOf(e.property)>=0?`Blade bindings that target a blade input are not supported. Inputs: '${pe(t.inputs)}'. Bindings: '${pe(t.bindings)}'.`:t.editScopeType&&e.property===x.EditScopeIdPropertyName?`Declaring an 'editScopeType' and an input binding with '${x.EditScopeIdPropertyName}' as a target property is not supported. ${o} Bindings: ${ge(this.bindings)}`:void 0)),n&&t.editScopeType&&ce(this.masterInputKeys)&&this.masterInputKeys.indexOf(x.EditScopeIdPropertyName)>=0&&(n=!1,s.push("Declaring an 'editScopeType' and receiving an '"+x.EditScopeIdPropertyName+"' from invocation values is not supported. "+o+` Invocation Properties: ${ge(this.masterInputKeys)}.`)),n&&k.CompositionBinder.modelHasPropertiesWithValue(this+"",t.templateKeyInputs,this.getViewModel()),s.length&&ee.error(`${s[0]} Blade:'${this.locator}'.`),n||this._composeErrorBlade(e,i,De.ErrorInitializing,"Unable to initialize blade from definition."),n}_findResourceId(){return this.assetId()||this.parent&&this.parent.getCurrentResourceId()}async _getExtensionPerfData(){const e=await this.bladeDefinitionPromise,t=e.viewModelBundleLoading;if(e.viewModelBundleLoading=null,!Ve(e))return;const i=await this._bladeViewModelDeferred.promise,n=null==i?void 0:i.internal;if(n){if(t){const e=n.getViewModelStart,i=t.end;e&&i&&(this._perfData.getViewModelDelay=e-i),this._perfData.bundleLoadingTime=t.duration}const e=n,i=t=>{var i;null===(i=e[t])||void 0===i||i.subscribeAndRun(this,(e=>{!MsPortalFx.isNullOrUndefined(e)&&(this._perfData[t]=e)}))};i("prepareFirstAjaxTime"),i("ajaxTime"),i("onInitializeAsyncTime"),i("reactViewInitializeEnd"),i("preAjaxRpc"),n.interruptedParent&&(this._perfData.interruptedParent=!0)}}}function Ee(e){return{id:_e(e.locator),instanceId:e.instanceId}}function Fe(e,t){const i=Le(e);for(let e=i.length-1;e>=0;e--){const n=i[e];if(t(n)){const e=n.containerWidget;if(e){const t=document.activeElement;t&&$.contains(e.element[0],t)||setTimeout((()=>{e.setFocus()}),150)}break}}}function ke(e,t,i,n,s,a,r,l){(0,A.getModelValue)(i,n).exists?e.mapProperty(n,r||n).bind(t,i,!0,(()=>{const e=ko.unwrap((0,A.getModelValue)(i,n,!0).value);s(e||a)})):l||o.isDesktopTraceEnabled&&ee.warning(`The Blade VM with id ${t} is missing the ${n} field.`)}function Re(e,t,i){oe&&ee.verbose(`[BladeRebinding] ${t} Blade: ${e}. Updated Properties: ${pe(i,null,2)||"N/A"}`)}function Ve(e){const t=(0,x.getBladeType)(e);return 3===t&&e.menuBlade.isV2||7===t&&e.tabMenuBlade.isV2||1===t&&e.templateBlade.isV2||2===t||5===t||6===t}function Ue(e){const t=e.getInputPropertyBindings();return!!(0,g.getGalleryItemIdFromBladeComposition)(Ie(e.locator),e.locator.name,t&&t.targetModel)}function Ae(e){return e.get(D.JourneyManager)}function Le(e){return e.diContainer.get(R.Finder).findBlades(e)}t.Instance=Te}));